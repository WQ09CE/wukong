name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    name: Test on ${{ matrix.os }} / Python ${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.9', '3.10', '3.11', '3.12']

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov

      - name: Run tests with coverage
        run: |
          python -m pytest tests/ -v --cov=wukong-dist --cov-report=xml --cov-report=term-missing

      - name: Upload coverage to Codecov
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          fail_ci_if_error: false

  lint-shell:
    name: Lint Shell Scripts
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get install -y shellcheck

      - name: Lint install.sh
        run: shellcheck install.sh

  lint-powershell:
    name: Lint PowerShell Scripts
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
          $results = Invoke-ScriptAnalyzer -Path install.ps1 -Severity Error,Warning
          if ($results) {
            $results | Format-Table -AutoSize
            # Warning only for now
          }
          Write-Host "PSScriptAnalyzer completed"

  hook-registration-test:
    name: Test Hook Registration
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run installation with hook registration
        run: |
          mkdir -p test-install
          # Create mock settings.json
          mkdir -p ~/.claude
          echo '{}' > ~/.claude/settings.json

          # Run install with hook registration (answer 'y')
          echo "y" | bash install.sh test-install

      - name: Verify hook registration
        run: |
          # Check settings.json was updated
          if grep -q "hui-extract.py" ~/.claude/settings.json; then
            echo "Hook registration verified!"
          else
            echo "Hook registration failed!"
            cat ~/.claude/settings.json
            exit 1
          fi

  install-test-unix:
    name: Test Installation (Unix)
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Create test directory
        run: mkdir -p test-install

      - name: Run installation
        run: |
          # Run from repo root so install.sh finds wukong-dist
          bash install.sh test-install <<< "n"

      - name: Verify installation
        run: |
          # Check core directories exist
          test -d test-install/.claude/rules || exit 1
          test -d test-install/.claude/skills || exit 1
          test -d test-install/.claude/commands || exit 1
          test -d test-install/.wukong || exit 1

          # Check core rule exists
          test -f test-install/.claude/rules/00-wukong-core.md || exit 1

          # Check runtime module installed (project level)
          test -d test-install/.wukong/runtime || exit 1
          test -f test-install/.wukong/runtime/scheduler.py || exit 1

          # Check context module installed (project level)
          test -d test-install/.wukong/context || exit 1
          test -f test-install/.wukong/context/snapshot.py || exit 1

          # Check global installation
          test -d ~/.wukong/runtime || exit 1
          test -d ~/.wukong/context || exit 1
          test -d ~/.wukong/hooks || exit 1

          echo "Installation verification passed!"

  install-test-windows:
    name: Test Installation (Windows)
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Create test directory
        run: mkdir test-install

      - name: Run installation
        shell: pwsh
        run: |
          # Run from repo root so install.ps1 finds wukong-dist
          echo "n" | pwsh -File install.ps1 -TargetDir test-install

      - name: Verify installation
        shell: pwsh
        run: |
          # Check core directories exist
          if (-not (Test-Path "test-install\.claude\rules")) { exit 1 }
          if (-not (Test-Path "test-install\.claude\skills")) { exit 1 }
          if (-not (Test-Path "test-install\.claude\commands")) { exit 1 }
          if (-not (Test-Path "test-install\.wukong")) { exit 1 }

          # Check core rule exists
          if (-not (Test-Path "test-install\.claude\rules\00-wukong-core.md")) { exit 1 }

          # Check runtime module installed (project level)
          if (-not (Test-Path "test-install\.wukong\runtime")) { exit 1 }
          if (-not (Test-Path "test-install\.wukong\runtime\scheduler.py")) { exit 1 }

          # Check context module installed (project level)
          if (-not (Test-Path "test-install\.wukong\context")) { exit 1 }
          if (-not (Test-Path "test-install\.wukong\context\snapshot.py")) { exit 1 }

          # Check global installation
          if (-not (Test-Path "$env:USERPROFILE\.wukong\runtime")) { exit 1 }
          if (-not (Test-Path "$env:USERPROFILE\.wukong\context")) { exit 1 }
          if (-not (Test-Path "$env:USERPROFILE\.wukong\hooks")) { exit 1 }

          Write-Host "Installation verification passed!"
