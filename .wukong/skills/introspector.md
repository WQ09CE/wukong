# Introspection Protocol (内观协议)

> **内观是横切能力，不是分身** - 内观专注于发现系统性问题并提出规则补丁。

本协议定义了 **内观** 横切能力的执行方式。内观由本体直接执行，不作为分身召唤。

## Core Focus (聚焦三件事)

> **内观悟空只做三件事**，每次反思必须产出这三部分：

```
┌──────────────────────────────────────────────────────────┐
│  1️⃣ 偏差诊断 (Deviation Diagnosis)                       │
│     本次协作哪里最浪费？为什么？                           │
│     (不是泛泛总结，而是定位具体的效率损失点)               │
├──────────────────────────────────────────────────────────┤
│  2️⃣ 规则补丁 (Rule Patch)                                │
│     需要新增/收紧/放宽哪条规则？                           │
│     (输出 diff-like 的规则修改建议)                       │
├──────────────────────────────────────────────────────────┤
│  3️⃣ 沉淀提炼 (Distillation)                              │
│     哪些信息值得写入阿赖耶识？                            │
│     (满足写入门槛才沉淀，不是什么都存)                    │
└──────────────────────────────────────────────────────────┘
```

## Identity

**内观**源自佛教"Vipassana"的概念——向内观察，洞察本质。在 Wukong 系统中，内观是一种**横切能力**，与末那识并列于元认知层。

> "吾日三省吾身" - 每次任务完成后，内观一次。

**与末那识的区别**:
| 能力 | 触发方式 | 职责 |
|------|----------|------|
| 末那识 | 每次分身输出后自动 | 实时纠偏（检测假设/偏执）|
| 内观 | 显式命令触发 | 阶段性反思（偏差/补丁/沉淀）|

**内观三件事**：
- **偏差诊断** - 定位协作过程中的效率损失点
- **规则补丁** - 提出具体的规则修改建议
- **沉淀提炼** - 识别值得写入阿赖耶识的知识

## When to Invoke (何时触发)

内观应在以下时机被触发：

1. **任务完成后** - 标准反思流程 (`/wukong 内观`)
2. **任务失败后** - 分析失败原因
3. **用户主动请求** - "反思一下"、"总结一下"
4. **复杂任务后** - 多分身协作的任务
5. **存档前** - 自动触发 T3 写入流程

## Introspection Dimensions (审视维度)

### 1. 分身配合 (Collaboration Analysis)

```
审视问题:
├── 分身选择是否正确？
│   └── 是否选择了最合适的分身类型？
├── 是否召唤了不必要的分身？
│   └── 有些工作本体可以直接完成
├── 是否遗漏了应该召唤的分身？
│   └── 例如：跳过了测试悟空
├── 分身之间的交接是否顺畅？
│   └── 上游输出是否满足下游需求
└── 是否存在职责重叠或空白？
```

**输出模板**:
```markdown
## 分身配合分析

### 召唤的分身
| 分身 | 任务 | 表现 | 改进建议 |
|------|------|------|----------|
| {avatar} | {task} | ✅/⚠️/❌ | {suggestion} |

### 分身选择评估
- 正确选择: {list}
- 不必要召唤: {list}
- 应该但未召唤: {list}

### 交接质量
{handoff analysis}
```

### 2. 并行效率 (Parallelization Analysis)

```
审视问题:
├── 哪些任务可以并行但实际串行了？
│   └── 错失的并行机会
├── 使用的并行模式是否最优？
│   └── 是否选择了正确的模式
├── 资源利用率如何？
│   └── 是否充分利用了 3-4 分身的限制
├── 是否有不必要的等待？
│   └── 阻塞点分析
└── 并行任务的合并是否顺利？
    └── 有无冲突或重复工作
```

**输出模板**:
```markdown
## 并行效率分析

### 执行模式
实际: {actual_pattern}
最优: {optimal_pattern}
效率损失: {efficiency_loss}

### 错失的并行机会
| 任务A | 任务B | 原因 | 预计节省 |
|-------|-------|------|----------|
| {task_a} | {task_b} | {reason} | {time_saved} |

### 并行模式使用情况
- 分身群攻: {used/not_used}
- 侦察兵+主力军: {used/not_used}
- TDD钳形攻势: {used/not_used}
- 代码+配置并行: {used/not_used}
- 蜂群模式: {used/not_used}

### 改进建议
{parallel_improvement_suggestions}
```

### 3. 上下文传递 (Context Flow Analysis)

```
审视问题:
├── 分身之间的信息传递是否完整？
│   └── 是否丢失了关键上下文
├── 是否有重复探索/重复工作？
│   └── 多个分身做了相同的事
├── 知识是否被正确记录？
│   └── 写入 notepads 了吗
├── 是否利用了之前的知识？
│   └── 读取并应用了之前的 learnings 吗
└── 上下文是否过载？
    └── 传递了太多不必要的信息
```

**输出模板**:
```markdown
## 上下文传递分析

### 信息流
```
{source} → {avatar_1} → {avatar_2} → {output}
          ↓           ↓
     {context_a}  {context_b}
```

### 问题发现
- 信息丢失: {lost_context}
- 重复工作: {duplicate_work}
- 上下文过载: {overload_issues}

### 知识管理
- 记录的知识: {recorded}
- 应该记录但未记录: {missing}
- 复用的知识: {reused}

### 改进建议
{context_improvement_suggestions}
```

### 4. 验证质量 (Verification Analysis)

```
审视问题:
├── 是否充分验证了分身的输出？
│   └── 运行了构建/测试/lint 吗
├── 是否过度信任分身声明？
│   └── "分身说完成了" ≠ 真的完成
├── 验证是否覆盖了所有交付物？
│   └── 每个产出都验证了吗
├── 是否有遗漏的边界条件？
│   └── 错误处理测试了吗
└── 最终状态是否干净？
    └── 无未提交的改动、无残留
```

**输出模板**:
```markdown
## 验证质量分析

### 验证执行情况
| 验证项 | 执行 | 结果 | 备注 |
|--------|------|------|------|
| 文件存在 | ✅/❌ | {result} | |
| 语法检查 | ✅/❌ | {result} | |
| 构建通过 | ✅/❌ | {result} | |
| 测试通过 | ✅/❌ | {result} | |
| 类型检查 | ✅/❌ | {result} | |

### 信任问题
- 过度信任的声明: {trusted_claims}
- 应该但未验证: {unverified}

### 改进建议
{verification_improvement_suggestions}
```

### 5. 用户交互 (User Interaction Analysis)

```
审视问题:
├── 是否及时汇报进度？
│   └── 用户是否清楚当前状态
├── 是否在需要时询问用户？
│   └── 模糊的地方有没有确认
├── 最终交付是否符合预期？
│   └── 用户要的和做的一致吗
├── 是否有过度询问？
│   └── 明显的事情不需要问
└── 沟通风格是否合适？
    └── 简洁、清晰、有条理
```

**输出模板**:
```markdown
## 用户交互分析

### 沟通质量
- 进度汇报: {frequency} 次
- 确认询问: {count} 次
- 用户满意度: {assessment}

### 问题发现
- 应该询问但未问: {should_ask}
- 不必要的询问: {unnecessary_ask}
- 沟通不清晰处: {unclear}

### 交付匹配度
用户需求: {user_request}
实际交付: {actual_delivery}
匹配度: {match_percentage}

### 改进建议
{interaction_improvement_suggestions}
```

### 6. 效率分析 (Efficiency Analysis)

```
审视问题:
├── 总体执行时间是否合理？
│   └── 与任务复杂度相比
├── 是否有明显的瓶颈？
│   └── 哪个环节最慢
├── 工具使用是否高效？
│   └── 有无冗余的工具调用
├── 是否有返工/重做？
│   └── 因为错误导致的重复工作
└── 下次如何更快？
    └── 具体的加速策略
```

**输出模板**:
```markdown
## 效率分析

### 时间分布
| 阶段 | 耗时 | 占比 | 是否合理 |
|------|------|------|----------|
| 需求理解 | {time} | {pct}% | ✅/❌ |
| 探索研究 | {time} | {pct}% | ✅/❌ |
| 设计 | {time} | {pct}% | ✅/❌ |
| 实现 | {time} | {pct}% | ✅/❌ |
| 验证 | {time} | {pct}% | ✅/❌ |

### 瓶颈识别
主要瓶颈: {bottleneck}
原因: {reason}
可优化: {optimization}

### 返工情况
返工次数: {rework_count}
返工原因: {rework_reasons}
可避免: {avoidable}

### 加速建议
{efficiency_improvement_suggestions}
```

## Introspection Report Template (内观报告模板)

> **内观输出必须包含三部分**: 偏差诊断 → 规则补丁 → 沉淀提炼

```markdown
# 内观报告: {task_name}

## 1️⃣ 偏差诊断 (Deviation Diagnosis)

### What Worked / What Failed
| 类别 | 内容 | 原因 | 可复用? |
|------|------|------|---------|
| ✅ Worked | {practice} | {why_worked} | Yes/No |
| ❌ Failed | {issue} | {why_failed} | - |

### Root Cause (根因分析)
```
问题: {observed_problem}
├── Why 1: {first_level}
├── Why 2: {second_level}
├── Why 3: {third_level}
├── Why 4: {fourth_level}
└── Why 5: {root_cause} ← 这是要解决的
```

**系统性原因**: {root_cause_summary}
**效率损失点**: {efficiency_loss_point}

## 2️⃣ 规则补丁 (Rule Patch)

> 如何防止此类问题再次发生？

### 补丁提案
```yaml
rule_patch:
  - action: add      # add | tighten | loosen | remove
    target: "{rule_file}.md"
    rule: "{new_rule_content}"
    reason: "{why_needed}"

  - action: tighten
    target: "{rule_file}.md"
    rule: "{existing_rule}"
    change: "{how_to_tighten}"
    reason: "{why_needed}"
```

### 补丁验证
- 验证方式: {how_to_verify}
- 影响范围: {impact_scope}

## 3️⃣ 沉淀提炼 (Distillation)

> 什么值得写入阿赖耶识？必须满足写入门槛！

### 写入门槛检查
```
□ 重复 ≥ 2: 类似问题/决策出现两次以上
□ 影响大: 涉及架构、安全、性能
□ 可复用: 在其他项目/场景中有参考价值
```

### 候选锚点
| ID | 类型 | 内容 | 满足门槛 | 写入? |
|----|------|------|----------|-------|
| D0xx | 决策 | {decision} | 重复/影响大/可复用 | ✅/❌ |
| M0xx | 模式 | {pattern} | {condition} | ✅/❌ |
| P0xx | 陷阱 | {pitfall} | {condition} | ✅/❌ |

### 沉淀分类
- **ADR/锚点**: {anchors_to_create}
- **Patterns**: {patterns_to_record}
- **Anti-patterns**: {antipatterns_to_record}
```

## Usage Guidelines (使用指南)

### 自动触发
```
任务完成后:
1. 本体完成验证
2. 向用户汇报结果
3. 【可选】召唤内观悟空进行反思
```

### 手动触发
```
用户说:
- "反思一下刚才的过程"
- "有什么可以改进的吗"
- "总结一下经验"
```

### 反思深度
```
快速反思 (1-2分钟):
- 只看关键维度
- 输出简要建议

深度反思 (5-10分钟):
- 完整审视所有维度
- 输出详细报告
- 更新 notepads
```

## Alaya T3: 阿赖耶识写入职责

> **内观悟空是阿赖耶识的"读写门户"** - 时机 3 (T3) 触发存档前的写入流程。

### T3 触发条件

| 条件 | 说明 |
|------|------|
| 用户触发 `存档` / `压缩` 命令 | 显式存档请求 |
| 上下文使用 > 85% | 自动触发存档 |
| 会话即将结束 | 确保知识不丢失 |
| 深度内观完成 | 标准反思流程结束 |

### T3 写入流程

```
内观完成 / 存档触发
        │
        ▼
┌─────────────────────────────────────────┐
│  Step 1: 收集候选锚点                    │
│  从沉淀提炼 (Distillation) 部分提取      │
│  候选类型: D(决策), P(陷阱), M(模式)     │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│  Step 2: 写入门槛检查 (至少满足一项)     │
│  ┌───────────────────────────────────┐  │
│  │ □ 重复性: 类似问题/决策 ≥ 2 次     │  │
│  │ □ 影响面: 架构/安全/性能/多模块    │  │
│  │ □ 可复用: 其他项目/场景有参考价值   │  │
│  └───────────────────────────────────┘  │
│  不满足门槛 → 跳过，不写入               │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│  Step 3: 去重检查                        │
│  - 查找相似度 > 0.8 的现有锚点           │
│  - 标题相似 → 合并或更新                 │
│  - 决策冲突 → 标记待人工审核             │
│  - 补充信息 → 追加到现有锚点             │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│  Step 4: 执行写入                        │
│  - 新锚点 → 写入 .wukong/context/anchors.md
│  - 合并锚点 → 更新现有条目               │
│  - 待审核 → 写入 anchors-pending.md     │
└─────────────────────────────────────────┘
```

### T3 输出格式

```markdown
## [Alaya T3] 写入报告

### 写入检查结果
| ID | 类型 | 内容 | 门槛 | 去重 | 结果 |
|----|------|------|------|------|------|
| D0xx | 决策 | {content} | ✅ 影响大 | 无重复 | 写入 |
| P0xx | 陷阱 | {content} | ✅ 重复≥2 | 合并到 P003 | 更新 |
| M0xx | 模式 | {content} | ❌ 不满足 | - | 跳过 |

### 写入统计
- 新增锚点: {count}
- 合并更新: {count}
- 待审核: {count}
- 跳过: {count}

### 锚点文件变更
- `.wukong/context/anchors.md` +{lines}
```

### 与内观三件事的关系

```
内观三件事                     T3 写入
┌─────────────────┐
│ 1️⃣ 偏差诊断     │ ──→ 识别是否有重复性问题
├─────────────────┤
│ 2️⃣ 规则补丁     │ ──→ 规则变更可能产生新锚点
├─────────────────┤
│ 3️⃣ 沉淀提炼     │ ──→ 候选锚点的主要来源
└─────────────────┘         │
                            ▼
                    [Alaya T3] 写入流程
```

详见: `.wukong/skills/alaya-injection.md`

## Anti-Patterns (禁忌)

**NEVER (绝不):**
- 为了反思而反思（简单任务不需要深度内观）
- 只批评不建议
- 忽略成功经验（只关注问题）
- 泛泛而谈（建议必须具体可行）

**ALWAYS (始终):**
- 客观中立地评估
- 提供具体可操作的建议
- 平衡肯定与改进
- 将有价值的发现记录到 notepads
