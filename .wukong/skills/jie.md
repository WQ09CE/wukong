# 戒 (Jie) - 规则检查模块

> **戒**：持守规则，不越雷池。

## 职责

戒模块负责检查分身输出是否违反规则，包括：
- Output Contract 完整性
- Do/Don't 边界遵守
- 安全检查

## 触发时机

```
分身输出 ──→ 戒 ──→ 定 ──→ 慧 ──→ 识
            ↑
          当前位置
```

## 检查清单

### 1. Contract 完整性

```
□ 必须输出的 section 是否齐全？
□ 格式是否符合规范？
□ 内容是否充实（非占位符）？
```

### 2. Do/Don't 边界

```
□ 是否只做允许的事？
□ 是否避免了禁止的事？
□ 是否有越界行为？
```

**六根分身边界速查**:

| 分身 | Do | Don't |
|------|-----|--------|
| 眼 | 搜索、定位 | 修改代码 |
| 耳 | 澄清需求、AC | 实现设计 |
| 鼻 | 审查、扫描 | 修复代码 |
| 舌 | 写测试文档 | 实现功能 |
| 身 | 写代码修复 | 跳过测试 |
| 意 | 架构设计 | 写实现 |

### 3. 安全检查

#### 系统安全

```
□ 敏感路径检查
   ├── /etc, /usr, /bin (系统文件)
   ├── ~/.ssh, ~/.gnupg, ~/.aws (敏感配置)
   └── ~/.bashrc, ~/.gitconfig (全局配置)
   → 如果涉及 → 必须用户确认

□ 危险命令检查
   ├── rm -rf (递归删除)
   ├── chmod 777 (开放权限)
   └── sudo / su (提权)
   → 如果包含 → 拒绝执行
```

#### 隐私保护

```
□ 敏感信息检测
   ├── API_KEY=, token=, secret=
   ├── password=, passwd=
   └── -----BEGIN PRIVATE KEY-----
   → 如果包含 → 禁止输出，要求脱敏

□ 敏感文件检测
   ├── .env, .env.local
   ├── credentials.json, secrets.yaml
   └── *.pem, *.key
   → 如果涉及 → 警告用户
```

#### 破坏性操作

```
□ 不可逆操作
   ├── rm, del, unlink
   ├── git reset --hard
   └── git push --force
   → 如果包含 → 必须确认 + 建议备份

□ 大规模变更
   ├── 批量文件修改 (>10 files)
   └── 全局搜索替换
   → 如果包含 → 分批执行
```

#### 代码安全

```
□ 注入风险
   ├── SQL 字符串拼接
   ├── os.system / shell=True
   └── 用户输入直接渲染 HTML
   → 如果包含 → 拒绝，要求安全方式

□ 硬编码检测
   ├── 硬编码凭证
   └── 硬编码 IP/端口
   → 如果包含 → 要求配置化
```

## 违规处理

| 违规类型 | 严重度 | 处理 |
|----------|--------|------|
| 修改系统文件 | CRITICAL | 立即拒绝 |
| 暴露敏感信息 | CRITICAL | 立即拒绝 + 脱敏 |
| 不可逆操作无确认 | HIGH | 阻塞，要求确认 |
| SQL/命令注入风险 | HIGH | 拒绝，要求重写 |
| Output 缺失必须 section | HIGH | 打回重做 |
| 越界行为 | HIGH | 打回重做 |
| 格式不规范 | MEDIUM | 警告 + 补充 |

## 输出格式

```markdown
## 戒关检查

**状态**: ✅ 通过 / ❌ 拒绝 / ⚠️ 需确认

### Contract 检查
- [x] sections 完整
- [x] 格式规范

### 边界检查
- [x] 未越界

### 安全检查
- [x] 无敏感路径
- [x] 无危险命令
- [x] 无敏感信息
- [x] 无注入风险

### 问题 (如有)
| 问题 | 严重度 | 处理 |
|------|--------|------|
| {问题描述} | {级别} | {处理方式} |
```

## 与其他模块关系

```
戒 (规则) ──→ 定 (复现) ──→ 慧 (反思) ──→ 识 (存储)
 │
 └── 不通过则打回，不进入后续流程
```
