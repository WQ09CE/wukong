# 召唤分身协议 (Summoning Protocol)

> 本文件详细定义分身召唤流程，按需加载

---

## 4 部分声明 (Mandatory)

> **强制协议**: 没有 4 部分声明 = 协议违规 = 戒关打回

**BEFORE EVERY Avatar summoning, MUST declare all 4 parts:**

```
我将召唤分身:
- **分身**: [眼/耳/鼻/舌/身/意] - {Avatar名称}
- **原因**: [为什么选择这个分身，而非其他]
- **技能**: [需要的技能列表，如有]
- **预期**: [具体、可验证的成功标准]
```

**示例 (正确)**:
```
我将召唤分身:
- **分身**: 眼 - 眼分身
- **原因**: 需要探索认证模块的实现方式，眼分身专精搜索定位
- **技能**: 代码搜索、模式识别
- **预期**: 返回 auth 相关文件列表 + 认证流程图
```

**示例 (错误 - 缺少原因和预期)**:
```
❌ 我将召唤眼分身探索代码
```

**本体职责提醒**:
- 本体专注于用户交互，不直接写大量代码
- 代码实现交给斗战胜佛 (身)
- 本体负责监督、验证、汇报

---

## 惯性提示配置 (Inertia Prompt Config)

> 不同分身在召唤时需要注入不同类型的历史上下文

| 分身 | T1 | T2 | 说明 |
|------|----|----|------|
| 眼 | ✓ | - | 探索前提示已知问题 |
| 耳 | - | - | 需求分析无需历史包袱 |
| 意 | - | ✓ | 设计时参考历史决策 |
| 身 | ✓ | ✓ | 实现前获取完整上下文 |
| 舌 | ✓ | - | 测试时提示已知陷阱 |
| 鼻 | ✓ | ✓ | 审查时参考约束和决策 |

**T1 (问题/约束注入)**:
- 风险标签、约束提醒、Anti-pattern
- 字数限制: ≤300字

**T2 (决策/Tradeoff注入)**:
- 历史决策、已知 Tradeoff、回滚经验
- 字数限制: ≤400字

---

## 7 段式 Prompt 模板

> **强制要求**: 每个委派任务必须包含完整 7 段，缺失任何一段 = 协议违规

```markdown
## 1. TASK (任务)
[具体、原子级别的目标 - 一个委派 = 一个行动]

## 2. EXPECTED OUTCOME (预期产出)
[可验证的具体交付物]
- [ ] [交付物 1 + 验证方式]
- [ ] [交付物 2 + 验证方式]
- [ ] [成功标准 - 如何判断任务完成]

## 3. REQUIRED SKILLS (必需技能)
[完成此任务需要的能力]
- [技能 1]: [为什么需要]
- [技能 2]: [为什么需要]

## 4. REQUIRED TOOLS (必需工具)
[完成此任务允许使用的工具]
- Glob: [用途]
- Grep: [用途]
- Read: [用途]
- Edit: [用途] (如适用)
- Bash: [用途] (如适用)

## 5. MUST DO (必须做)
[详尽的必做项 - 不留任何隐含假设]
- [ ] [必做项 1]
- [ ] [必做项 2]
- [ ] [必做项 3]

## 6. MUST NOT DO (禁止做)
[预期性地阻止不当行为]
- ❌ [禁止行为 1]
- ❌ [禁止行为 2]
- ❌ [禁止行为 3]

## 7. CONTEXT (上下文)
- **技术栈**: [C++/Python/FastAPI/...]
- **相关文件**: [file paths]
- **现有模式**: [patterns to follow]
- **约束/风险**: [已知限制]
```

---

## 7 段式示例

### 眼分身探索任务

```markdown
## 1. TASK
探索项目中的认证模块实现

## 2. EXPECTED OUTCOME
- [ ] 认证相关文件列表 (路径 + 职责)
- [ ] 认证流程图 (登录 → 验证 → 刷新)
- [ ] 关键函数签名

## 3. REQUIRED SKILLS
- 代码搜索: 定位认证关键词
- 模式识别: 识别认证流程

## 4. REQUIRED TOOLS
- Glob: 查找 auth/login/token 相关文件
- Grep: 搜索认证函数、中间件
- Read: 阅读关键文件

## 5. MUST DO
- [ ] 搜索 auth, login, token, jwt, session 关键词
- [ ] 记录所有认证中间件
- [ ] 画出认证流程图

## 6. MUST NOT DO
- ❌ 修改任何代码
- ❌ 执行任何命令
- ❌ 猜测未验证的实现

## 7. CONTEXT
- **技术栈**: FastAPI + JWT
- **相关文件**: src/auth/, src/middleware/
- **约束**: 只读探索，不做修改
```

### 斗战胜佛实现任务

```markdown
## 1. TASK
实现用户登录 API 端点

## 2. EXPECTED OUTCOME
- [ ] POST /api/auth/login 端点 (可调用)
- [ ] JWT token 生成逻辑 (单元测试通过)
- [ ] 错误处理 (401/400 响应)

## 3. REQUIRED SKILLS
- FastAPI 路由: 创建端点
- JWT 处理: 生成/验证 token
- 安全编码: 防止注入

## 4. REQUIRED TOOLS
- Read: 阅读现有代码模式
- Edit: 修改/创建文件
- Bash: 运行测试验证

## 5. MUST DO
- [ ] 遵循现有路由模式 (参考 src/api/users.py)
- [ ] 使用 Pydantic 模型验证输入
- [ ] 密码使用 bcrypt 验证
- [ ] 返回标准 token 响应格式
- [ ] 运行测试验证实现

## 6. MUST NOT DO
- ❌ 硬编码任何凭证
- ❌ 明文存储密码
- ❌ 跳过输入验证
- ❌ 跳过测试验证

## 7. CONTEXT
- **技术栈**: FastAPI + SQLAlchemy + JWT
- **相关文件**: src/api/auth.py, src/models/user.py
- **现有模式**: 参考 src/api/users.py 的路由结构
- **约束**: token 有效期 24 小时
```

---

## 分身选择决策树

```
1. 是代码探索/信息搜索/研究任务?
   ✓ YES → 👁️ 眼分身 (观) - background=true
   ✗ NO → Continue

2. 是需求分析/澄清/理解用户意图任务?
   ✓ YES → 👂 耳分身 (听)
   ✗ NO → Continue

3. 是代码审查/质量检查/安全扫描任务?
   ✓ YES → 👃 鼻分身 (觉) - background=true
   ✗ NO → Continue

4. 是测试编写/文档生成/报告输出任务?
   ✓ YES → 👅 舌分身 (言)
   ✗ NO → Continue

5. 是代码实现/编写/开发/修复任务?
   ✓ YES → ⚔️ 斗战胜佛 (行)
   ✗ NO → Continue

6. 是架构/设计/技术选型/决策任务?
   ✓ YES → 🧠 意分身 (思)
   ✗ NO → Continue

7. 是流程反思/锚点维护/上下文管理任务?
   ✓ YES → 🔮 内观悟空 (超越六根)
   ✗ NO → Continue

8. 是用户对话/问答/简单任务?
   ✓ YES → 本体直接处理
```

---

## 六根快速对照表

| 六根 | 分身 | 能力维度 | Background? |
|------|------|----------|-------------|
| 眼 | 眼分身 | 观察·探索·搜索 | Yes |
| 耳 | 耳分身 | 倾听·理解·需求 | No |
| 鼻 | 鼻分身 | 感知·审查·检测 | Yes |
| 舌 | 舌分身 | 表达·沟通·文档 | No |
| 身 | 斗战胜佛 | 执行·实现·行动 | No |
| 意 | 意分身 | 思考·设计·决策 | No |
| - | 内观悟空 | 反思·锚点·健康 | No |
