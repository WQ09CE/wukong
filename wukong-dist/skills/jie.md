# æˆ’ (Jie) - è§„åˆ™æ£€æŸ¥æ¨¡å—

> **æˆ’**ï¼šæŒå®ˆè§„åˆ™ï¼Œä¸è¶Šé›·æ± ã€‚

## èŒè´£

æˆ’æ¨¡å—è´Ÿè´£æ£€æŸ¥åˆ†èº«è¾“å‡ºæ˜¯å¦è¿åè§„åˆ™ï¼ŒåŒ…æ‹¬ï¼š
- Output Contract å®Œæ•´æ€§
- Do/Don't è¾¹ç•Œéµå®ˆ
- å®‰å…¨æ£€æŸ¥

## è§¦å‘æ—¶æœº

```
åˆ†èº«è¾“å‡º â”€â”€â†’ æˆ’ â”€â”€â†’ å®š â”€â”€â†’ æ…§ â”€â”€â†’ è¯†
            â†‘
          å½“å‰ä½ç½®
```

## æ£€æŸ¥æ¸…å•

### 1. Contract å®Œæ•´æ€§

```
â–¡ å¿…é¡»è¾“å‡ºçš„ section æ˜¯å¦é½å…¨ï¼Ÿ
â–¡ æ ¼å¼æ˜¯å¦ç¬¦åˆè§„èŒƒï¼Ÿ
â–¡ å†…å®¹æ˜¯å¦å……å®ï¼ˆéå ä½ç¬¦ï¼‰ï¼Ÿ
```

### 2. Do/Don't è¾¹ç•Œ

```
â–¡ æ˜¯å¦åªåšå…è®¸çš„äº‹ï¼Ÿ
â–¡ æ˜¯å¦é¿å…äº†ç¦æ­¢çš„äº‹ï¼Ÿ
â–¡ æ˜¯å¦æœ‰è¶Šç•Œè¡Œä¸ºï¼Ÿ
```

**å…­æ ¹åˆ†èº«è¾¹ç•Œé€ŸæŸ¥**:

| åˆ†èº« | Do | Don't |
|------|-----|--------|
| çœ¼ | æœç´¢ã€å®šä½ | ä¿®æ”¹ä»£ç  |
| è€³ | æ¾„æ¸…éœ€æ±‚ã€AC | å®ç°è®¾è®¡ |
| é¼» | å®¡æŸ¥ã€æ‰«æ | ä¿®å¤ä»£ç  |
| èˆŒ | å†™æµ‹è¯•æ–‡æ¡£ | å®ç°åŠŸèƒ½ |
| èº« | å†™ä»£ç ä¿®å¤ | è·³è¿‡æµ‹è¯• |
| æ„ | æ¶æ„è®¾è®¡ | å†™å®ç° |

### 3. å®‰å…¨æ£€æŸ¥

#### ç³»ç»Ÿå®‰å…¨

```
â–¡ æ•æ„Ÿè·¯å¾„æ£€æŸ¥
   â”œâ”€â”€ /etc, /usr, /bin (ç³»ç»Ÿæ–‡ä»¶)
   â”œâ”€â”€ ~/.ssh, ~/.gnupg, ~/.aws (æ•æ„Ÿé…ç½®)
   â””â”€â”€ ~/.bashrc, ~/.gitconfig (å…¨å±€é…ç½®)
   â†’ å¦‚æœæ¶‰åŠ â†’ å¿…é¡»ç”¨æˆ·ç¡®è®¤

â–¡ å±é™©å‘½ä»¤æ£€æŸ¥
   â”œâ”€â”€ rm -rf (é€’å½’åˆ é™¤)
   â”œâ”€â”€ chmod 777 (å¼€æ”¾æƒé™)
   â””â”€â”€ sudo / su (ææƒ)
   â†’ å¦‚æœåŒ…å« â†’ æ‹’ç»æ‰§è¡Œ
```

#### éšç§ä¿æŠ¤

```
â–¡ æ•æ„Ÿä¿¡æ¯æ£€æµ‹
   â”œâ”€â”€ API_KEY=, token=, secret=
   â”œâ”€â”€ password=, passwd=
   â””â”€â”€ -----BEGIN PRIVATE KEY-----
   â†’ å¦‚æœåŒ…å« â†’ ç¦æ­¢è¾“å‡ºï¼Œè¦æ±‚è„±æ•

â–¡ æ•æ„Ÿæ–‡ä»¶æ£€æµ‹
   â”œâ”€â”€ .env, .env.local
   â”œâ”€â”€ credentials.json, secrets.yaml
   â””â”€â”€ *.pem, *.key
   â†’ å¦‚æœæ¶‰åŠ â†’ è­¦å‘Šç”¨æˆ·
```

#### ç ´åæ€§æ“ä½œ

```
â–¡ ä¸å¯é€†æ“ä½œ
   â”œâ”€â”€ rm, del, unlink
   â”œâ”€â”€ git reset --hard
   â””â”€â”€ git push --force
   â†’ å¦‚æœåŒ…å« â†’ å¿…é¡»ç¡®è®¤ + å»ºè®®å¤‡ä»½

â–¡ å¤§è§„æ¨¡å˜æ›´
   â”œâ”€â”€ æ‰¹é‡æ–‡ä»¶ä¿®æ”¹ (>10 files)
   â””â”€â”€ å…¨å±€æœç´¢æ›¿æ¢
   â†’ å¦‚æœåŒ…å« â†’ åˆ†æ‰¹æ‰§è¡Œ
```

#### ä»£ç å®‰å…¨

```
â–¡ æ³¨å…¥é£é™©
   â”œâ”€â”€ SQL å­—ç¬¦ä¸²æ‹¼æ¥
   â”œâ”€â”€ os.system / shell=True
   â””â”€â”€ ç”¨æˆ·è¾“å…¥ç›´æ¥æ¸²æŸ“ HTML
   â†’ å¦‚æœåŒ…å« â†’ æ‹’ç»ï¼Œè¦æ±‚å®‰å…¨æ–¹å¼

â–¡ ç¡¬ç¼–ç æ£€æµ‹
   â”œâ”€â”€ ç¡¬ç¼–ç å‡­è¯
   â””â”€â”€ ç¡¬ç¼–ç  IP/ç«¯å£
   â†’ å¦‚æœåŒ…å« â†’ è¦æ±‚é…ç½®åŒ–
```

## è¿è§„å¤„ç†

| è¿è§„ç±»å‹ | ä¸¥é‡åº¦ | å¤„ç† |
|----------|--------|------|
| ä¿®æ”¹ç³»ç»Ÿæ–‡ä»¶ | CRITICAL | ç«‹å³æ‹’ç» |
| æš´éœ²æ•æ„Ÿä¿¡æ¯ | CRITICAL | ç«‹å³æ‹’ç» + è„±æ• |
| ä¸å¯é€†æ“ä½œæ— ç¡®è®¤ | HIGH | é˜»å¡ï¼Œè¦æ±‚ç¡®è®¤ |
| SQL/å‘½ä»¤æ³¨å…¥é£é™© | HIGH | æ‹’ç»ï¼Œè¦æ±‚é‡å†™ |
| Output ç¼ºå¤±å¿…é¡» section | HIGH | æ‰“å›é‡åš |
| è¶Šç•Œè¡Œä¸º | HIGH | æ‰“å›é‡åš |
| æ ¼å¼ä¸è§„èŒƒ | MEDIUM | è­¦å‘Š + è¡¥å…… |

## è¾“å‡ºæ ¼å¼

```markdown
## æˆ’å…³æ£€æŸ¥

**çŠ¶æ€**: âœ… é€šè¿‡ / âŒ æ‹’ç» / âš ï¸ éœ€ç¡®è®¤

### Contract æ£€æŸ¥
- [x] sections å®Œæ•´
- [x] æ ¼å¼è§„èŒƒ

### è¾¹ç•Œæ£€æŸ¥
- [x] æœªè¶Šç•Œ

### å®‰å…¨æ£€æŸ¥
- [x] æ— æ•æ„Ÿè·¯å¾„
- [x] æ— å±é™©å‘½ä»¤
- [x] æ— æ•æ„Ÿä¿¡æ¯
- [x] æ— æ³¨å…¥é£é™©

### é—®é¢˜ (å¦‚æœ‰)
| é—®é¢˜ | ä¸¥é‡åº¦ | å¤„ç† |
|------|--------|------|
| {é—®é¢˜æè¿°} | {çº§åˆ«} | {å¤„ç†æ–¹å¼} |
```

## ä¸å…¶ä»–æ¨¡å—å…³ç³»

```
æˆ’ (è§„åˆ™) â”€â”€â†’ å®š (å¤ç°) â”€â”€â†’ æ…§ (åæ€) â”€â”€â†’ è¯† (å­˜å‚¨)
 â”‚
 â””â”€â”€ ä¸é€šè¿‡åˆ™æ‰“å›ï¼Œä¸è¿›å…¥åç»­æµç¨‹
```

---

## é”™è¯¯åˆ†ç±»ä½“ç³» (Error Classification)

> å€Ÿé‰´è‡ª oh-my-opencode çš„ç»†ç²’åº¦é”™è¯¯æ¢å¤æœºåˆ¶

### å…­ç±»é”™è¯¯ä¸æ¢å¤ç­–ç•¥

| é”™è¯¯ç±»å‹ | æ£€æµ‹æ¨¡å¼ | ä¸¥é‡åº¦ | æ¢å¤ç­–ç•¥ |
|----------|----------|--------|----------|
| **Edit Failure** | `oldString not found` ç­‰ | HIGH | READ éªŒè¯åé‡è¯• |
| **Tool Result Missing** | tool_use/tool_result é…å¯¹å¤±è´¥ | HIGH | æ³¨å…¥å ä½ç¬¦ç»“æœ |
| **Context Exceeded** | `token limit`, `prompt too long` | CRITICAL | ä¸‰é˜¶æ®µå‹ç¼© |
| **Permission Denied** | `EACCES`, `Permission denied` | HIGH | ç”¨æˆ·ç¡®è®¤ |
| **File Not Found** | `ENOENT`, `No such file` | MEDIUM | Glob æœç´¢åé‡è¯• |
| **Empty Content** | æ¶ˆæ¯æ— æœ‰æ•ˆå†…å®¹ | MEDIUM | æ³¨å…¥å ä½ç¬¦ |

### é”™è¯¯æ£€æµ‹æ¸…å•

```
â–¡ Edit é”™è¯¯?
  â”œâ”€â”€ oldString not found â†’ READ éªŒè¯
  â”œâ”€â”€ oldString found multiple times â†’ å¢åŠ ä¸Šä¸‹æ–‡
  â””â”€â”€ oldString = newString â†’ æ£€æŸ¥é€»è¾‘

â–¡ å·¥å…·ç»“æœç¼ºå¤±?
  â””â”€â”€ tool_use æ— å¯¹åº” tool_result â†’ æ³¨å…¥å ä½ç¬¦

â–¡ ä¸Šä¸‹æ–‡æº¢å‡º?
  â””â”€â”€ token è¶…é™ â†’ ä¸‰é˜¶æ®µå‹ç¼©:
      Phase 1: å‰ªæé‡å¤å·¥å…·è°ƒç”¨
      Phase 2: æˆªæ–­å¤§è¾“å‡º
      Phase 3: ç”Ÿæˆæ‘˜è¦

â–¡ æƒé™é—®é¢˜?
  â””â”€â”€ æ“ä½œè¢«æ‹’ç» â†’ ç”¨æˆ·ç¡®è®¤åé‡è¯•

â–¡ æ–‡ä»¶ä¸å­˜åœ¨?
  â””â”€â”€ è·¯å¾„é”™è¯¯ â†’ Glob æœç´¢æ­£ç¡®è·¯å¾„
```

### ä¸‰é˜¶æ®µä¸Šä¸‹æ–‡æ¢å¤

> å·²åœ¨ hui-extract.py ä¸­å®ç°ï¼Œç”± PreCompact Hook è‡ªåŠ¨è§¦å‘

```
ä¸Šä¸‹æ–‡ä½¿ç”¨ç‡ç›‘æ§
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Stage 1: ğŸŸ¡ 70% è­¦å‘Š                             â”‚
â”‚  â”œâ”€ è¾“å‡ºè­¦å‘Šæç¤º                                   â”‚
â”‚  â”œâ”€ æé†’ä»£ç†ä¸è¦ä»“ä¿ƒè¡ŒåŠ¨                           â”‚
â”‚  â””â”€ å»ºè®®åˆé€‚æ—¶æœºæ‰§è¡Œ /wukong å‹ç¼©                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ ç»§ç»­ä½¿ç”¨
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Stage 2: ğŸŸ  85% ä¸»åŠ¨å‹ç¼©                         â”‚
â”‚  â”œâ”€ [DCP] åŠ¨æ€ä¸Šä¸‹æ–‡å‰ªæ                           â”‚
â”‚  â”‚   â”œâ”€ è¯†åˆ«é‡å¤å·¥å…·è°ƒç”¨ (ç›¸åŒç­¾å)                â”‚
â”‚  â”‚   â”œâ”€ ä¿æŠ¤å…³é”®å·¥å…· (Task, TodoWrite, Edit)      â”‚
â”‚  â”‚   â””â”€ ç§»é™¤å†—ä½™ï¼Œåªä¿ç•™æœ€æ–°                       â”‚
â”‚  â”œâ”€ [Truncation] æˆªæ–­å¤§å‹è¾“å‡º                      â”‚
â”‚  â”‚   â”œâ”€ å•ä¸ªå·¥å…·è¾“å‡ºé™åˆ¶ 2000 å­—ç¬¦                 â”‚
â”‚  â”‚   â””â”€ ä¿ç•™å…ƒæ•°æ® (å·¥å…·åã€çŠ¶æ€)                  â”‚
â”‚  â””â”€ æç¤ºå®Œæˆå½“å‰ä»»åŠ¡åå‹ç¼©                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ ç»§ç»­ä½¿ç”¨
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Stage 3: ğŸ”´ 100% ç´§æ€¥æ•‘æ´                        â”‚
â”‚  â”œâ”€ æ›´æ¿€è¿›çš„ DCP (ç›®æ ‡å‰Šå‡ 70%)                   â”‚
â”‚  â”œâ”€ ä¿ç•™å…³é”®ä¸Šä¸‹æ–‡                                 â”‚
â”‚  â”‚   â”œâ”€ å½“å‰ä»»åŠ¡æè¿°                              â”‚
â”‚  â”‚   â”œâ”€ å…³é”®å†³ç­–å’Œçº¦æŸ                            â”‚
â”‚  â”‚   â””â”€ æœªå®Œæˆä»»åŠ¡åˆ—è¡¨                            â”‚
â”‚  â”œâ”€ ç”Ÿæˆç´§æ€¥æ‘˜è¦                                   â”‚
â”‚  â””â”€ æ³¨å…¥ "continue" æŒ‡ä»¤                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å—ä¿æŠ¤çš„å·¥å…·** (ä¸ä¼šè¢« DCP å‰ªæ):
- Task, TodoWrite, Edit, Write, lsp_rename

**å¯å‰ªæçš„å·¥å…·åŠä¿ç•™æ•°é‡**:
| å·¥å…· | ä¿ç•™æœ€è¿‘ N æ¬¡ |
|------|--------------|
| Glob | 3 |
| Grep | 3 |
| Read | 5 |
| Bash | 3 |
| WebSearch | 2 |
| WebFetch | 2 |

### ä¼šè¯çº§é”™è¯¯æ¢å¤

> å·²åœ¨ hui-extract.py ä¸­å®ç°ï¼Œè‡ªåŠ¨æ£€æµ‹å’Œæ¢å¤

```
æ£€æµ‹çš„é”™è¯¯ç±»å‹:

â–¡ ç¼ºå¤±å·¥å…·ç»“æœ (tool_result_missing)
  â”œâ”€ æ£€æµ‹: tool_use æ— å¯¹åº” tool_result
  â”œâ”€ åŸå› : ç”¨æˆ·ä¸­æ–­ (ESC)ã€è¶…æ—¶ã€æ‰§è¡Œå¤±è´¥
  â””â”€ æ¢å¤: æ³¨å…¥å ä½ç¬¦ï¼Œæç¤ºæ£€æŸ¥æ“ä½œ

â–¡ ç©ºæ¶ˆæ¯ (empty_message)
  â”œâ”€ æ£€æµ‹: Assistant æ¶ˆæ¯æ— å†…å®¹
  â””â”€ æ¢å¤: è‡ªåŠ¨æ¸…ç†

â–¡ æ€è€ƒå—é—®é¢˜ (thinking_block_error)
  â”œâ”€ æ£€æµ‹: æ€è€ƒå—æ ¼å¼é”™è¯¯
  â””â”€ æ¢å¤: éªŒè¯å¹¶æ¸…ç†
```

**æ¢å¤æµç¨‹**:
```
PreCompact è§¦å‘
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ detect_session_ â”‚
â”‚ errors()        â”‚ â† æ£€æµ‹ä¼šè¯é”™è¯¯
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ generate_       â”‚
â”‚ recovery_prompt â”‚ â† ç”Ÿæˆæ¢å¤æç¤º
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¾“å‡ºåˆ° Claude   â”‚ â† æ³¨å…¥æ¢å¤æŒ‡ä»¤
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é˜²é‡å¤æœºåˆ¶

```python
# æ¢å¤çŠ¶æ€ä¿å­˜åˆ° .wukong/context/current/recovery-state.json
# åŒ…å«:
# - timestamp: æ¢å¤æ—¶é—´
# - stage: å½“å‰é˜¶æ®µ
# - usage: ä¸Šä¸‹æ–‡ä½¿ç”¨ç‡
# - session_errors_count: ä¼šè¯é”™è¯¯æ•°
# - dcp_stats: DCP ç»Ÿè®¡ä¿¡æ¯
```

### é”™è¯¯æ¢å¤è¾“å‡ºæ ¼å¼

```markdown
## æˆ’å…³æ£€æŸ¥ - é”™è¯¯æ¢å¤

**é”™è¯¯ç±»å‹**: {category}
**ä¸¥é‡åº¦**: {severity}
**åŒ¹é…æ¨¡å¼**: {matched_pattern}

### æ¢å¤ç­–ç•¥

{recovery_prompt}

### çŠ¶æ€
- [ ] é”™è¯¯å·²åˆ†ç±»
- [ ] æ¢å¤ç­–ç•¥å·²æ‰§è¡Œ
- [ ] éªŒè¯æ¢å¤æˆåŠŸ
```
