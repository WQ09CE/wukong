# 慧 (Hui) - 反思与沉淀模块

> **慧**：洞察本质，超越表象。及时反思，及时沉淀。

## 职责

慧模块是 Wukong 的"智慧核心"，负责：
- **末那识扫描** - 检测假设/偏执 (横切能力)
- **内观反思** - 诊断偏差，提出规则补丁
- **成果验证** - 检查验证充分性
- **上下文精简** - 提炼关键信息
- **触发识的写入** - 识别值得沉淀的锚点

## 触发时机

```
分身输出 ──→ 戒 ──→ 定 ──→ 慧 ──→ 识
                         ↑
                       当前位置

额外触发:
├── /wukong 内观        (手动)
├── PreCompact Hook     (自动压缩前)
└── 复杂任务完成后       (自动)
```

## 末那识扫描 (横切能力)

> 末那识不在流水线中，而是**横切能力**，随时检测分身输出中的假设和偏执。

### 扫描模式

```
任何分身输出 ──→ 末那识扫描
                    │
                    ├─ Assumptions: 隐含假设
                    ├─ Evidence missing: 缺少证据
                    ├─ Scope creep: 范围蔓延风险
                    └─ Suggested checks: 建议验证
```

### 危险信号 (必须拦截)

```
⚠️ L0 推测语言:
├── "应该可以..." / "大概能..."
├── "我觉得..." / "我认为..."
├── "一般来说..." / "通常..."
├── "显然..." / "当然..."
└── "没有问题" / "应该没事"

处理: 标记 + 要求证据
```

### 健康信号 (可通过)

```
✅ 有证据支撑:
├── "根据 {path}:{line}，..."
├── "执行 {command} 输出 {result}"
├── "测试 {test_name} 通过"
└── "[D001] 决策: ..."

处理: 通过
```

### 上下文锚定偏差 (Context Anchoring Bias)

> **常见陷阱**：被当前会话上下文锚定，忽略更大范围的数据

```
⚠️ 锚定触发词:
├── "今天所有/全部工作" → 可能有多个 session
├── "我的全部项目" → 可能跨多个项目
├── "最近的改动" → 可能跨分支/跨项目
└── "总结一下" → 需确认范围

错误行为: 只看当前 session/项目
正确行为: 先扫描跨 session 数据
```

| 用户说 | 错误理解 | 正确理解 |
|--------|---------|---------|
| "今天所有工作" | 当前会话的工作 | 今天所有 session 的工作 |
| "我的全部项目" | 当前项目 | 所有活跃项目 |
| "最近的改动" | 当前分支改动 | 可能跨分支/跨项目 |

**处理**: 识别锚定触发词 → 扫描跨 session 数据 → 再做总结

### 末那识输出

```markdown
## 末那识检查

**输入**: {分身输出摘要}

### 检测到的假设
| 假设 | 类型 | 风险 | 处理 |
|------|------|------|------|
| "这个函数应该能处理空值" | L0 推测 | 高 | 需测试 |

### 过滤决定
- ✅ 通过: {可信内容}
- ⚠️ 待验证: {需要验证的内容}
- ❌ 拒绝: {L0 推测，需重做}
```

## 内观反思

> 内观专注于发现系统性问题并提出规则补丁。

### 内观前置检查 (防止锚定偏差)

> **收到内观请求时，先确定范围，再做反思**

```
收到内观/总结请求
      │
      ▼
┌─────────────────────────────────────────┐
│  🔍 范围确认 (防锚定偏差):              │
│                                         │
│  Q1. 用户说"今天/所有/全部"吗？          │
│      → 是 → 需要跨 session 数据         │
│      → 否 → 当前 session 即可           │
│                                         │
│  Q2. 需要跨 session 时:                 │
│      1. Read ~/.wukong/context/index.json│
│      2. 按日期/项目过滤相关 session      │
│      3. Read 各 session 的 compact.md   │
│      4. 汇总后再内观                     │
└─────────────────────────────────────────┘
```

### 跨 Session 内观流程

```python
# 1. 读取 session 索引
index = Read("~/.wukong/context/index.json")

# 2. 过滤今天的 session (按日期)
today = date.today().strftime("%Y%m%d")
today_sessions = [s for s in index["sessions"]
                  if s["id"].contains(today)]

# 3. 读取各 session 的精简上下文
for session in today_sessions:
    compact = Read(f"~/.wukong/context/sessions/{session['id']}/compact.md")
    # 提取: 项目、任务、决策、问题

# 4. 汇总后做内观
```

### 跨 Session 内观输出

```markdown
## 今日工作内观: {date}

### Session 概览
| Session | 项目 | 主要任务 | 关键决策 |
|---------|------|----------|----------|
| {id1} | {proj1} | {task1} | {decision1} |
| {id2} | {proj2} | {task2} | {decision2} |

### 跨 Session 模式
- **共性模式**: {发现的共同模式}
- **关联问题**: {跨 session 的关联}

### 分 Session 详情
#### Session: {id1} - {project}
{该 session 的内观}

#### Session: {id2} - {project}
{该 session 的内观}

### 沉淀建议
{值得写入 .wukong/context 的内容}
```

### 内观三件事

```
┌──────────────────────────────────────────────────────────┐
│  1. 偏差诊断 (Deviation Diagnosis)                       │
│     本次协作哪里最浪费？为什么？                          │
├──────────────────────────────────────────────────────────┤
│  2. 规则补丁 (Rule Patch)                                │
│     需要新增/收紧/放宽哪条规则？                          │
├──────────────────────────────────────────────────────────┤
│  3. 沉淀提炼 (Distillation)                              │
│     哪些信息值得写入识？                                  │
└──────────────────────────────────────────────────────────┘
```

### 审视维度

1. **分身配合** - 选择是否正确？有无遗漏？
2. **并行效率** - 有无错失的并行机会？
3. **上下文传递** - 信息是否完整传递？
4. **验证质量** - 验证是否充分？
5. **用户交互** - 沟通是否清晰？
6. **效率分析** - 有无明显瓶颈？

### 内观输出

```markdown
## 内观报告: {task_name}

### 1. 偏差诊断
**效率损失点**: {具体描述}
**根因**: {分析}

### 2. 规则补丁
```yaml
rule_patch:
  - action: add|tighten|loosen|remove
    target: "{rule_file}.md"
    rule: "{内容}"
    reason: "{原因}"
```

### 3. 沉淀提炼
| ID | 类型 | 内容 | 满足门槛 | 写入? |
|----|------|------|----------|-------|
| D0xx | 决策 | {decision} | 影响大 | ✅ |
| P0xx | 陷阱 | {pitfall} | 重复≥2 | ✅ |
```

## 验证充分性检查

```
□ 核心路径是否有 L2/L3 验证？
□ 边界条件是否测试？
□ 错误处理是否验证？
```

### 验证评分

| 等级 | 描述 |
|------|------|
| A | L3 验证 + 边界 + 错误处理 |
| B | L2 验证 + 部分边界 |
| C | L2 验证，边界不足 |
| D | L1 或更低，需补充 |

## 上下文精简

> 为识模块准备精简的上下文。

### 三态压缩

```
🔶 巨形态 (完整) → 🔹 常形态 (结构化) → 🔸 缩形态 (<500字)
```

### 精简原则

**保留**:
- 决策结论 (不是讨论过程)
- 接口签名 (不是实现细节)
- 约束规则 (不是背景解释)
- 当前状态 (不是历史过程)
- 锚点引用

**丢弃**:
- 探索性讨论
- 已否决的方案
- 临时调试信息
- 重复的确认对话

## 锚点提取

> 识别值得沉淀到识的信息。

### 写入门槛 (至少满足一项)

```
□ 重复 ≥ 2: 类似问题/决策出现两次以上
□ 影响大: 涉及架构、安全、性能、多模块
□ 可复用: 在其他项目/场景中有参考价值
```

### 锚点类型

| 类型 | 前缀 | 说明 |
|------|------|------|
| 决策 | D | 架构/技术决策 |
| 约束 | C | 必须遵守的规则 |
| 接口 | I | 关键接口定义 |
| 问题 | P | 已知问题/陷阱 |
| 模式 | M | 可复用模式 |

### 锚点格式

```markdown
## [D001] {决策标题}

**日期**: {date}
**状态**: ✅ 生效 / ⚠️ 待验证 / ❌ 已废弃

### Decision
{做了什么决定}

### Alternatives
| 方案 | 优点 | 缺点 |
|------|------|------|
| A | ... | ... |
| B | ... | ... |

### Why
{选择的理由}

### Impact
{影响范围}

### Rollback
{如何回滚}
```

## PreCompact Hook 集成

> 慧模块可通过 PreCompact Hook 在自动压缩前触发。

### Hook 配置

```json
{
  "hooks": {
    "PreCompact": [{
      "matcher": "auto",
      "hooks": [{
        "type": "command",
        "command": "python3 ~/.wukong/hooks/hui-extract.py"
      }]
    }]
  }
}
```

### Hook 执行流程

```
PreCompact 触发
      │
      ▼
hui-extract.py
      │
      ├─ 读取 transcript_path (完整对话)
      ├─ 末那识扫描 (检测假设)
      ├─ 提取关键信息 (决策/约束/接口)
      ├─ 生成精简上下文
      └─ 触发识写入
            │
            ├─ current/compact.md
            └─ anchors.md (新锚点)
```

## 与其他模块关系

```
戒 (规则) ──→ 定 (复现) ──→ 慧 (反思) ──→ 识 (存储)
                            │
                            ├─ 末那识: 随时可扫描任意分身输出
                            ├─ 内观: 手动或任务完成后触发
                            └─ PreCompact: 自动压缩前触发
```

## 禁忌

**NEVER**:
- 为了反思而反思（简单任务不需要深度内观）
- 只批评不建议
- 泛泛而谈（建议必须具体可行）
- 跳过门槛检查直接沉淀

**ALWAYS**:
- 客观中立地评估
- 提供具体可操作的建议
- 平衡肯定与改进
- 检查门槛后再触发识写入
