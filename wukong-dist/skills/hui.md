# 慧 (Hui) - 反思与沉淀模块

> **慧**：洞察本质，超越表象。及时反思，及时沉淀。

## 职责

慧模块是 Wukong 的"智慧核心"，负责：
- **末那识扫描** - 检测假设/偏执 (横切能力)
- **内观反思** - 诊断偏差，提出规则补丁
- **成果验证** - 检查验证充分性
- **上下文精简** - 提炼关键信息
- **触发识的写入** - 识别值得沉淀的锚点

## 触发时机

```
分身输出 ──→ 戒 ──→ 定 ──→ 慧 ──→ 识
                         ↑
                       当前位置

额外触发:
├── /wukong 内观        (手动)
├── PreCompact Hook     (自动压缩前)
└── 复杂任务完成后       (自动)
```

## 末那识扫描 (横切能力)

> 末那识不在流水线中，而是**横切能力**，随时检测分身输出中的假设和偏执。

### 扫描模式

```
任何分身输出 ──→ 末那识扫描
                    │
                    ├─ Assumptions: 隐含假设
                    ├─ Evidence missing: 缺少证据
                    ├─ Scope creep: 范围蔓延风险
                    └─ Suggested checks: 建议验证
```

### 危险信号 (必须拦截)

```
⚠️ L0 推测语言:
├── "应该可以..." / "大概能..."
├── "我觉得..." / "我认为..."
├── "一般来说..." / "通常..."
├── "显然..." / "当然..."
└── "没有问题" / "应该没事"

处理: 标记 + 要求证据
```

### 健康信号 (可通过)

```
✅ 有证据支撑:
├── "根据 {path}:{line}，..."
├── "执行 {command} 输出 {result}"
├── "测试 {test_name} 通过"
└── "[D001] 决策: ..."

处理: 通过
```

### 上下文锚定偏差 (Context Anchoring Bias)

> **常见陷阱**：被当前会话上下文锚定，忽略更大范围的数据

```
⚠️ 锚定触发词:
├── "今天所有/全部工作" → 可能有多个 session
├── "我的全部项目" → 可能跨多个项目
├── "最近的改动" → 可能跨分支/跨项目
└── "总结一下" → 需确认范围

错误行为: 只看当前 session/项目
正确行为: 先扫描跨 session 数据
```

| 用户说 | 错误理解 | 正确理解 |
|--------|---------|---------|
| "今天所有工作" | 当前会话的工作 | 今天所有 session 的工作 |
| "我的全部项目" | 当前项目 | 所有活跃项目 |
| "最近的改动" | 当前分支改动 | 可能跨分支/跨项目 |

**处理**: 识别锚定触发词 → 扫描跨 session 数据 → 再做总结

### 末那识输出

```markdown
## 末那识检查

**输入**: {分身输出摘要}

### 检测到的假设
| 假设 | 类型 | 风险 | 处理 |
|------|------|------|------|
| "这个函数应该能处理空值" | L0 推测 | 高 | 需测试 |

### 过滤决定
- ✅ 通过: {可信内容}
- ⚠️ 待验证: {需要验证的内容}
- ❌ 拒绝: {L0 推测，需重做}
```

## 内观反思

> 内观专注于发现系统性问题并提出规则补丁。
>
> **完整的内观执行流程见**: `~/.claude/commands/neiguan.md`

### 内观命令

```
/wukong 内观
```

执行内观时，**必须遵循 BLOCKING checklist**（见 `neiguan.md`）：

1. **Step 1**: Read `~/.wukong/context/index.json`
2. **Step 2**: Read ALL relevant `sessions/*/compact.md`
3. **Step 3**: Read `~/.wukong/context/anchors.md`
4. **Step 4**: Generate output

> **警告**: 跳过任何步骤 = 协议违规。常见错误：只读 index.json 和 anchors，漏掉 sessions 目录。

### 内观三件事

```
┌──────────────────────────────────────────────────────────┐
│  1. 偏差诊断 (Deviation Diagnosis)                       │
│     本次协作哪里最浪费？为什么？                          │
├──────────────────────────────────────────────────────────┤
│  2. 规则补丁 (Rule Patch)                                │
│     需要新增/收紧/放宽哪条规则？                          │
├──────────────────────────────────────────────────────────┤
│  3. 沉淀提炼 (Distillation)                              │
│     哪些信息值得写入识？                                  │
└──────────────────────────────────────────────────────────┘
```

### 审视维度

1. **分身配合** - 选择是否正确？有无遗漏？
2. **并行效率** - 有无错失的并行机会？
3. **上下文传递** - 信息是否完整传递？
4. **验证质量** - 验证是否充分？
5. **用户交互** - 沟通是否清晰？
6. **效率分析** - 有无明显瓶颈？

### 内观输出

```markdown
## 内观报告: {task_name}

### 1. 偏差诊断
**效率损失点**: {具体描述}
**根因**: {分析}

### 2. 规则补丁
```yaml
rule_patch:
  - action: add|tighten|loosen|remove
    target: "{rule_file}.md"
    rule: "{内容}"
    reason: "{原因}"
```

### 3. 沉淀提炼
| ID | 类型 | 内容 | 满足门槛 | 写入? |
|----|------|------|----------|-------|
| D0xx | 决策 | {decision} | 影响大 | ✅ |
| P0xx | 陷阱 | {pitfall} | 重复≥2 | ✅ |
```

## 验证充分性检查

```
□ 核心路径是否有 L2/L3 验证？
□ 边界条件是否测试？
□ 错误处理是否验证？
```

### 验证评分

| 等级 | 描述 |
|------|------|
| A | L3 验证 + 边界 + 错误处理 |
| B | L2 验证 + 部分边界 |
| C | L2 验证，边界不足 |
| D | L1 或更低，需补充 |

## 上下文精简

> 为识模块准备精简的上下文。

### 三态压缩

```
🔶 巨形态 (完整) → 🔹 常形态 (结构化) → 🔸 缩形态 (<500字)
```

### 精简原则

**保留**:
- 决策结论 (不是讨论过程)
- 接口签名 (不是实现细节)
- 约束规则 (不是背景解释)
- 当前状态 (不是历史过程)
- 锚点引用

**丢弃**:
- 探索性讨论
- 已否决的方案
- 临时调试信息
- 重复的确认对话

## 锚点提取

> 识别值得沉淀到识的信息。

### 写入门槛 (至少满足一项)

```
□ 重复 ≥ 2: 类似问题/决策出现两次以上
□ 影响大: 涉及架构、安全、性能、多模块
□ 可复用: 在其他项目/场景中有参考价值
```

### 锚点类型

| 类型 | 前缀 | 说明 |
|------|------|------|
| 决策 | D | 架构/技术决策 |
| 约束 | C | 必须遵守的规则 |
| 接口 | I | 关键接口定义 |
| 问题 | P | 已知问题/陷阱 |
| 模式 | M | 可复用模式 |

### 锚点格式

```markdown
## [D001] {决策标题}

**日期**: {date}
**状态**: ✅ 生效 / ⚠️ 待验证 / ❌ 已废弃

### Decision
{做了什么决定}

### Alternatives
| 方案 | 优点 | 缺点 |
|------|------|------|
| A | ... | ... |
| B | ... | ... |

### Why
{选择的理由}

### Impact
{影响范围}

### Rollback
{如何回滚}
```

## PreCompact Hook 集成

> 慧模块可通过 PreCompact Hook 在自动压缩前触发。

### Hook 配置

```json
{
  "hooks": {
    "PreCompact": [{
      "matcher": "auto",
      "hooks": [{
        "type": "command",
        "command": "python3 ~/.wukong/hooks/hui-extract.py"
      }]
    }]
  }
}
```

### Hook 执行流程

```
PreCompact 触发
      │
      ▼
hui-extract.py
      │
      ├─ 读取 transcript_path (完整对话)
      ├─ 末那识扫描 (检测假设)
      ├─ 提取关键信息 (决策/约束/接口)
      ├─ 生成精简上下文
      └─ 触发识写入
            │
            ├─ current/compact.md
            └─ anchors.md (新锚点)
```

## 与其他模块关系

```
戒 (规则) ──→ 定 (复现) ──→ 慧 (反思) ──→ 识 (存储)
                            │
                            ├─ 末那识: 随时可扫描任意分身输出
                            ├─ 内观: 手动或任务完成后触发
                            └─ PreCompact: 自动压缩前触发
```

## 禁忌

**NEVER**:
- 为了反思而反思（简单任务不需要深度内观）
- 只批评不建议
- 泛泛而谈（建议必须具体可行）
- 跳过门槛检查直接沉淀

**ALWAYS**:
- 客观中立地评估
- 提供具体可操作的建议
- 平衡肯定与改进
- 检查门槛后再触发识写入

---

## 内观分身调用指南

> 以下内容整合自 introspector.md，提供详细的内观执行指南。

### 触发时机 (When to Invoke)

内观应在以下时机被触发：

1. **任务完成后** - 标准反思流程 (`/wukong 内观`)
2. **任务失败后** - 分析失败原因
3. **用户主动请求** - "反思一下"、"总结一下"
4. **复杂任务后** - 多分身协作的任务
5. **存档前** - 自动触发 T3 写入流程

### 审视维度详细模板

#### 1. 分身配合分析

```
审视问题:
├── 分身选择是否正确？
├── 是否召唤了不必要的分身？
├── 是否遗漏了应该召唤的分身？
├── 分身之间的交接是否顺畅？
└── 是否存在职责重叠或空白？
```

**输出模板**:
```markdown
## 分身配合分析

### 召唤的分身
| 分身 | 任务 | 表现 | 改进建议 |
|------|------|------|----------|
| {avatar} | {task} | ✅/⚠️/❌ | {suggestion} |

### 分身选择评估
- 正确选择: {list}
- 不必要召唤: {list}
- 应该但未召唤: {list}

### 交接质量
{handoff analysis}
```

#### 2. 并行效率分析

```
审视问题:
├── 哪些任务可以并行但实际串行了？
├── 使用的并行模式是否最优？
├── 资源利用率如何？
├── 是否有不必要的等待？
└── 并行任务的合并是否顺利？
```

**输出模板**:
```markdown
## 并行效率分析

### 执行模式
实际: {actual_pattern}
最优: {optimal_pattern}
效率损失: {efficiency_loss}

### 错失的并行机会
| 任务A | 任务B | 原因 | 预计节省 |
|-------|-------|------|----------|
| {task_a} | {task_b} | {reason} | {time_saved} |

### 并行模式使用情况
- 分身群攻: {used/not_used}
- 侦察兵+主力军: {used/not_used}
- TDD钳形攻势: {used/not_used}
```

#### 3. 上下文传递分析

```
审视问题:
├── 分身之间的信息传递是否完整？
├── 是否有重复探索/重复工作？
├── 知识是否被正确记录？
├── 是否利用了之前的知识？
└── 上下文是否过载？
```

**输出模板**:
```markdown
## 上下文传递分析

### 信息流
{source} → {avatar_1} → {avatar_2} → {output}

### 问题发现
- 信息丢失: {lost_context}
- 重复工作: {duplicate_work}
- 上下文过载: {overload_issues}

### 知识管理
- 记录的知识: {recorded}
- 应该记录但未记录: {missing}
- 复用的知识: {reused}
```

#### 4. 验证质量分析

```
审视问题:
├── 是否充分验证了分身的输出？
├── 是否过度信任分身声明？
├── 验证是否覆盖了所有交付物？
├── 是否有遗漏的边界条件？
└── 最终状态是否干净？
```

**输出模板**:
```markdown
## 验证质量分析

### 验证执行情况
| 验证项 | 执行 | 结果 | 备注 |
|--------|------|------|------|
| 文件存在 | ✅/❌ | {result} | |
| 语法检查 | ✅/❌ | {result} | |
| 构建通过 | ✅/❌ | {result} | |
| 测试通过 | ✅/❌ | {result} | |

### 信任问题
- 过度信任的声明: {trusted_claims}
- 应该但未验证: {unverified}
```

#### 5. 用户交互分析

```
审视问题:
├── 是否及时汇报进度？
├── 是否在需要时询问用户？
├── 最终交付是否符合预期？
├── 是否有过度询问？
└── 沟通风格是否合适？
```

**输出模板**:
```markdown
## 用户交互分析

### 沟通质量
- 进度汇报: {frequency} 次
- 确认询问: {count} 次
- 用户满意度: {assessment}

### 交付匹配度
用户需求: {user_request}
实际交付: {actual_delivery}
匹配度: {match_percentage}
```

#### 6. 效率分析

```
审视问题:
├── 总体执行时间是否合理？
├── 是否有明显的瓶颈？
├── 工具使用是否高效？
├── 是否有返工/重做？
└── 下次如何更快？
```

**输出模板**:
```markdown
## 效率分析

### 时间分布
| 阶段 | 耗时 | 占比 | 是否合理 |
|------|------|------|----------|
| 需求理解 | {time} | {pct}% | ✅/❌ |
| 探索研究 | {time} | {pct}% | ✅/❌ |
| 设计 | {time} | {pct}% | ✅/❌ |
| 实现 | {time} | {pct}% | ✅/❌ |
| 验证 | {time} | {pct}% | ✅/❌ |

### 瓶颈识别
主要瓶颈: {bottleneck}
原因: {reason}
可优化: {optimization}
```

### Alaya T3: 阿赖耶识写入流程

> **内观是阿赖耶识的"读写门户"** - 时机 3 (T3) 触发存档前的写入流程。

#### T3 触发条件

| 条件 | 说明 |
|------|------|
| 用户触发 `存档` / `压缩` 命令 | 显式存档请求 |
| 上下文使用 > 85% | 自动触发存档 |
| 会话即将结束 | 确保知识不丢失 |
| 深度内观完成 | 标准反思流程结束 |

#### T3 写入流程

```
内观完成 / 存档触发
        │
        ▼
┌─────────────────────────────────────────┐
│  Step 1: 收集候选锚点                    │
│  从沉淀提炼 (Distillation) 部分提取      │
│  候选类型: D(决策), P(陷阱), M(模式)     │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│  Step 2: 写入门槛检查 (至少满足一项)     │
│  ┌───────────────────────────────────┐  │
│  │ □ 重复性: 类似问题/决策 ≥ 2 次     │  │
│  │ □ 影响面: 架构/安全/性能/多模块    │  │
│  │ □ 可复用: 其他项目/场景有参考价值   │  │
│  └───────────────────────────────────┘  │
│  不满足门槛 → 跳过，不写入               │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│  Step 3: 去重检查                        │
│  - 查找相似度 > 0.8 的现有锚点           │
│  - 标题相似 → 合并或更新                 │
│  - 决策冲突 → 标记待人工审核             │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│  Step 4: 执行写入                        │
│  - 新锚点 → 写入 .wukong/context/anchors.md
│  - 合并锚点 → 更新现有条目               │
│  - 待审核 → 写入 anchors-pending.md     │
└─────────────────────────────────────────┘
```

#### T3 输出格式

```markdown
## [Alaya T3] 写入报告

### 写入检查结果
| ID | 类型 | 内容 | 门槛 | 去重 | 结果 |
|----|------|------|------|------|------|
| D0xx | 决策 | {content} | ✅ 影响大 | 无重复 | 写入 |
| P0xx | 陷阱 | {content} | ✅ 重复≥2 | 合并到 P003 | 更新 |

### 写入统计
- 新增锚点: {count}
- 合并更新: {count}
- 待审核: {count}
- 跳过: {count}
```

### 反思深度指南

```
快速反思 (1-2分钟):
- 只看关键维度
- 输出简要建议

深度反思 (5-10分钟):
- 完整审视所有维度
- 输出详细报告
- 触发 T3 写入流程
```