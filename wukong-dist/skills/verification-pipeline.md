# 验证流水线协议 (Verification Pipeline Protocol)

> **Version**: 1.0
>
> 统一定义戒定慧三关的递进关系、状态转移、失败处理

---

## 流水线概览

```
分身输出
    │
    ▼
┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
│   戒    │ ──→ │   定    │ ──→ │   慧    │ ──→ │   识    │
│ (规则)  │     │ (复现)  │     │ (反思)  │     │ (存储)  │
└────┬────┘     └────┬────┘     └────┬────┘     └─────────┘
     │               │               │
     ▼               ▼               ▼
  REJECT          RETRY          FEEDBACK
  (打回)          (重试)          (规则补丁)
```

**设计原则**:
- 戒关是"门禁"，不通过则不进入后续流程
- 定关是"验证"，确保输出可复现
- 慧关是"反思"，提炼经验并触发沉淀
- 识是"存储"，持久化关键信息

---

## 状态定义

| 状态 | 含义 | 后续动作 |
|------|------|----------|
| **PASS** | 通过当前关 | 进入下一关 |
| **REJECT** | 严重违规 | 打回分身重做，流水线终止 |
| **RETRY** | 可修复问题 | 分身修复后重试当前关 |
| **SKIP** | 可跳过 | 直接进入下一关 |
| **FEEDBACK** | 需反馈 | 生成规则补丁建议，继续流程 |

### 状态转移图

```
                    ┌──────────────────────────────────────────────────────┐
                    │                                                      │
                    ▼                                                      │
分身输出 ──→ [戒关] ──→ PASS ──→ [定关] ──→ PASS ──→ [慧关] ──→ PASS ──→ [识] ──→ 完成
                │                   │                   │
                │ REJECT            │ RETRY             │ FEEDBACK
                ▼                   ▼                   ▼
           打回重做            修复后重试          规则补丁建议
                │                   │                   │
                └───────────────────┴───────────────────┘
                        重新进入流水线
```

---

## 递进规则

### 1. 戒关 → 定关

| 戒关结果 | 是否进入定关 | 说明 |
|----------|-------------|------|
| **PASS** | ✅ YES | 正常流转 |
| **REJECT** | ❌ NO | 打回重做，不进入定关 |

**关键**: 戒关 REJECT = 流水线终止，必须重做

```
戒关检查清单:
├── Contract 完整性 → 缺失必须字段 → REJECT
├── Do/Don't 边界 → 越界行为 → REJECT
└── 安全检查 → 危险操作/敏感信息 → REJECT
```

### 2. 定关 → 慧关

| 定关结果 | 证据等级 | 是否进入慧关 | 说明 |
|----------|----------|-------------|------|
| **PASS + L2/L3** | 高 | ✅ YES | 正常流转 |
| **PASS + L1** | 中 | ⚠️ 条件 | 简单任务可跳过慧关 |
| **PASS + L0** | 低 | ❌ NO | 打回补充证据 |
| **RETRY** | - | ❌ NO | 修复后重试定关 |

**跳过慧关的条件** (满足任一即可跳过):
- Track D (Direct) 的简单任务
- 眼/耳/鼻分身的探索/分析输出 (非实现类)
- 用户明确要求快速完成
- 单文件、少于 20 行的小修改

```
定关证据等级判定:
├── L0 (推测) → 立即 REJECT，要求验证
├── L1 (引用) → 简单任务 PASS，复杂任务要求 L2
├── L2 (本地验证) → PASS
└── L3 (集成验证) → PASS (最高信任)
```

### 3. 慧关 → 识

| 慧关结果 | 是否写入识 | 说明 |
|----------|-----------|------|
| **发现值得沉淀的锚点** | ✅ YES | 满足门槛则写入 |
| **无新锚点** | ⭕ 可选 | 更新 compact.md |
| **发现规则问题** | ⚠️ FEEDBACK | 生成规则补丁建议 |
| **发现需回溯的问题** | 🔄 回溯 | 回到戒/定关重新检查 |

**识写入门槛** (至少满足一项):
- 重复 ≥ 2: 类似问题/决策出现两次以上
- 影响大: 涉及架构、安全、性能、多模块
- 可复用: 在其他项目/场景中有参考价值

---

## 失败处理分类

### 严重失败 (REJECT) - 必须重做

> 这类失败表示分身输出存在根本性问题，不可通过简单修复解决

| 失败类型 | 触发关 | 检测标志 | 处理 |
|----------|--------|----------|------|
| **安全违规** | 戒 | 敏感路径/危险命令/凭证暴露 | 立即拒绝，不可重试 |
| **Contract 缺失** | 戒 | 必须字段为空 | 打回，要求补全 |
| **越界行为** | 戒 | Do/Don't 边界违反 | 打回，指出违规 |
| **L0 推测无证据** | 定 | "应该可以"/"大概能" | 打回，要求验证 |

**REJECT 处理流程**:
```
检测到 REJECT 条件
        │
        ▼
┌──────────────────────┐
│ 1. 记录违规详情       │
│ 2. 生成明确的修复指令 │
│ 3. 打回给原分身       │
│ 4. 重置流水线状态     │
└──────────────────────┘
        │
        ▼
   分身重做 → 重新进入戒关
```

### 可修复失败 (RETRY) - 修复后重试

> 这类失败可以通过补充信息或简单修复解决

| 失败类型 | 触发关 | 检测标志 | 处理 |
|----------|--------|----------|------|
| **格式不规范** | 戒 | 非关键字段缺失/格式错误 | 警告 + 要求补充 |
| **L1 证据不足** | 定 | 只有引用无本地验证 | 要求补充 L2 验证 |
| **测试失败** | 定 | pytest/ctest 失败 | 分身修复后重试 |
| **构建失败** | 定 | cmake/make 错误 | 分身修复后重试 |
| **类型检查失败** | 定 | mypy 报错 | 分身修复后重试 |

**RETRY 重试限制**:
```
第 1 次失败 → 修复后重试
第 2 次失败 → 分析根本原因，再修复
第 3 次失败 → 停止，升级给用户

升级步骤:
1. 记录所有尝试
2. 捕获错误信息
3. 识别可能原因
4. 向用户请求指导
```

### 反馈型失败 (FEEDBACK) - 需要规则改进

> 这类失败不阻塞流程，但需要记录并建议改进

| 失败类型 | 触发关 | 检测标志 | 处理 |
|----------|--------|----------|------|
| **规则冲突** | 慧 | 两条规则产生矛盾 | 生成规则补丁建议 |
| **效率问题** | 慧 | 明显的并行/缓存机会 | 记录偏差，建议改进 |
| **重复问题** | 慧 | 类似问题第 2 次出现 | 沉淀为问题锚点 |
| **边界模糊** | 慧 | Do/Don't 定义不清晰 | 建议收紧/放宽规则 |

**FEEDBACK 输出格式**:
```yaml
rule_patch:
  - action: add|tighten|loosen|remove
    target: "{rule_file}.md"
    rule: "{内容}"
    reason: "{原因}"
    priority: HIGH|MEDIUM|LOW
```

---

## 回溯规则

### 何时需要回溯？

```
慧关发现问题
        │
        ▼
┌───────────────────────────────────────────────────────────┐
│                    问题类型判断                            │
├───────────────────────────────────────────────────────────┤
│ 1. 规则理解错误   → 回溯到戒关重新检查 (漏检/误判)         │
│ 2. 验证不充分     → 回溯到定关补充验证 (证据等级不足)      │
│ 3. 效率建议       → 不回溯，记录到识 (FEEDBACK)           │
│ 4. 新发现约束     → 不回溯，添加到锚点 (沉淀)             │
└───────────────────────────────────────────────────────────┘
```

### 回溯条件详解

| 回溯类型 | 触发条件 | 回溯目标 | 重新检查内容 |
|----------|----------|----------|--------------|
| **回溯到戒** | 发现漏检的安全问题 | 戒关 | 完整安全检查 |
| **回溯到戒** | 发现 Contract 违规 | 戒关 | Contract 完整性 |
| **回溯到定** | 发现证据不可靠 | 定关 | 补充 L2/L3 验证 |
| **回溯到定** | 发现遗漏的测试场景 | 定关 | 补充测试用例 |

### 回溯流程

```
慧关发现需要回溯
        │
        ├─→ 回溯到戒关:
        │   ┌────────────────────────┐
        │   │ 1. 标记回溯原因         │
        │   │ 2. 重新检查 Contract    │
        │   │ 3. 重新检查安全         │
        │   │ 4. 通过后继续到定关     │
        │   └────────────────────────┘
        │
        └─→ 回溯到定关:
            ┌────────────────────────┐
            │ 1. 标记回溯原因         │
            │ 2. 补充验证命令         │
            │ 3. 提升证据等级         │
            │ 4. 通过后继续到慧关     │
            └────────────────────────┘
```

### 回溯计数与限制

```
同一分身输出的回溯次数:
├── 回溯 1 次 → 正常处理
├── 回溯 2 次 → 警告，详细分析
└── 回溯 3 次 → 停止，升级给用户

升级时提供:
- 回溯历史
- 每次回溯的原因
- 建议的解决方向
```

---

## 轨道特定验证规则

| 轨道 | 戒关重点 | 定关门槛 | 慧关深度 | 跳过慧关? |
|------|----------|----------|----------|-----------|
| **Feature** | Contract 完整 | L2 + AC 测试全通过 | 完整内观 | ❌ 不可跳过 |
| **Fix** | 安全检查 + 回归风险 | L2 + 复现用例 + 回归测试 | 问题锚点提取 | ⚠️ 小修复可跳过 |
| **Refactor** | 边界检查 + 行为保持 | L2 + 行为不变证明 | 决策锚点提取 | ❌ 不可跳过 |
| **Direct** | 基础安全检查 | L1 可接受 | 可跳过 | ✅ 可跳过 |

### 轨道验证详解

#### Feature 轨道
```
戒关:
├── Contract 必须完整 (goal, AC, files_changed 等)
├── 不允许跳过任何必须字段
└── 安全检查严格执行

定关:
├── 必须达到 L2 (本地验证)
├── 所有 AC (验收标准) 必须有对应测试
└── 测试必须全部通过

慧关:
├── 执行完整内观 (分身配合、并行效率、验证质量)
├── 提取决策锚点
└── 检查是否有可沉淀的模式
```

#### Fix 轨道
```
戒关:
├── 安全检查 (修复是否引入新风险)
├── 回归风险评估
└── Contract 基本完整

定关:
├── 必须达到 L2
├── 复现用例: 能重现原问题
├── 修复验证: 修复后问题不再出现
└── 回归测试: 原有功能不受影响

慧关:
├── 提取问题锚点 (P 类型)
├── 分析是否为重复问题
└── 小修复 (<20行、单文件) 可跳过
```

#### Refactor 轨道
```
戒关:
├── 边界检查 (是否只做重构，不改行为)
├── 禁止功能变更
└── Contract 完整

定关:
├── 必须达到 L2
├── 行为不变证明: 重构前后测试结果一致
└── 性能不退化 (如适用)

慧关:
├── 提取决策锚点 (D 类型)
├── 记录重构原因和权衡
└── 分析是否有可复用模式
```

#### Direct 轨道
```
戒关:
├── 基础安全检查 (无危险命令)
└── Contract 可简化

定关:
├── L1 (引用) 可接受
├── 简单任务无需测试
└── 快速验证即可

慧关:
├── 可跳过
└── 或仅做简单记录
```

---

## 并行验证规则

### 批次验证原则

> 每个并行批次完成后，必须立即验证，才能开始下一批次。

```
❌ 最后才验证 (问题积累):
批次1 → 批次2 → 批次3 → 最终验证 → 发现批次1有问题 → 大量返工

✅ 批次验证 (尽早发现):
批次1 → 验证 ✓ → 批次2 → 验证 ✓ → 批次3 → 验证 ✓ → 完成
```

### 批次验证流程

```
并行批次完成
      │
      ▼
┌─────────────────────────────────────┐
│ 批次验证 (简化三关)                   │
├─────────────────────────────────────┤
│ 1. 快速戒关: Contract 存在性检查      │
│ 2. 快速定关: 文件存在 + 语法检查      │
│ 3. 跳过慧关: 批次验证不需要反思       │
└─────────────────────────────────────┘
      │
      ├─ PASS → 继续下一批次
      └─ FAIL → 停止，修复后重试当前批次
```

### 最终验证

```
所有批次完成
      │
      ▼
┌─────────────────────────────────────┐
│ 最终验证 (完整三关)                   │
├─────────────────────────────────────┤
│ 1. 戒关: 完整 Contract 检查           │
│ 2. 定关: 集成测试 + L2/L3 验证        │
│ 3. 慧关: 完整内观 + 锚点提取          │
└─────────────────────────────────────┘
      │
      ▼
    识写入
```

---

## 验证命令速查

### 快速验证 (批次内)

```bash
# Python
python -m py_compile {file}  # 语法检查
python -c "import {module}"  # 导入检查

# C++
cmake --build build --target {target}  # 增量构建

# 通用
ls -la {expected_files}  # 文件存在检查
```

### 完整验证 (最终)

```bash
# Python
ruff check . && mypy src/ && pytest -v

# C++
cmake -B build && cmake --build build -j && ctest --test-dir build

# FastAPI
pytest tests/api/ -v && curl http://localhost:8000/health
```

---

## 输出格式

### 流水线状态报告

```markdown
## 验证流水线报告

**任务**: {task_name}
**轨道**: {track}
**分身**: {avatar}

### 流水线状态

| 关卡 | 状态 | 详情 |
|------|------|------|
| 戒 | ✅ PASS | Contract 完整，无安全问题 |
| 定 | ✅ PASS (L2) | 测试通过 15/15 |
| 慧 | ✅ PASS | 提取锚点 [D003] |
| 识 | ✅ 已写入 | anchors.md 已更新 |

### 验证详情

#### 戒关
- [x] Contract 完整性
- [x] Do/Don't 边界
- [x] 安全检查

#### 定关
- **证据等级**: L2
- **验证命令**: `pytest -v`
- **结果**: 15 passed, 0 failed

#### 慧关
- **内观评分**: B
- **新锚点**: [D003] xxx
- **规则补丁**: 无

### 回溯记录 (如有)
| 次数 | 回溯目标 | 原因 | 结果 |
|------|----------|------|------|
| 1 | 定关 | 缺少回归测试 | 已补充 |
```

---

## 与其他模块关系

```
┌──────────────────────────────────────────────────────────────────┐
│                        验证流水线                                 │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  jie.md          ding.md         hui.md          shi.md         │
│    │                │               │               │            │
│    ▼                ▼               ▼               ▼            │
│  ┌────┐          ┌────┐          ┌────┐          ┌────┐         │
│  │ 戒 │ ───────→ │ 定 │ ───────→ │ 慧 │ ───────→ │ 识 │         │
│  └────┘          └────┘          └────┘          └────┘         │
│    │                │               │                            │
│    │ REJECT         │ RETRY         │ FEEDBACK                   │
│    │                │               │                            │
│    └────────────────┴───────────────┴─→ 回到分身                 │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘

引用关系:
- verification-pipeline.md (本文件) - 统一定义递进关系
- jie.md - 戒关详细规则、边界定义、安全检查
- ding.md - 定关详细规则、证据等级、验证命令
- hui.md - 慧关详细规则、内观、锚点提取
- shi.md - 识存储规则、三态、惯性提示
```

---

## 禁忌

**NEVER**:
- 跳过戒关直接进入定关
- L0 推测通过定关
- 不检查门槛就触发识写入
- 无限制回溯 (最多 3 次)
- 批次验证失败后继续下一批次

**ALWAYS**:
- 戒关 REJECT = 流水线终止
- 定关至少 L1，复杂任务至少 L2
- 慧关检查门槛后触发识
- 记录回溯原因和次数
- 批次验证后再继续
