# Wukong Multi-Agent Framework Overview
# 悟空多分身协作框架总览

> **Version**: 2.0
> **Date**: 2026-01-12
> **Status**: Reference Manual

---

## System Manifesto (系统宣言)

> **六根并行生产，末那识破执纠偏；戒定慧三关护航；内观驱动规则迭代；阿赖耶识沉淀为长期能力。**

---

## 1. Framework Overview (框架概览)

**一句话描述**: Wukong 是一个基于佛教六根/八识哲学的多 Agent 协作框架，通过分身系统、验证流水线和智能上下文管理，实现高效、可靠的 AI 辅助开发。

### Architecture Diagram (架构图)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Wukong Multi-Agent System                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                         User Interface Layer                             │ │
│  │  ┌───────────────────────────────────────────────────────────────────┐  │ │
│  │  │                        悟空本体 (Wukong Prime)                      │  │ │
│  │  │   - 用户交互        - 任务分析        - 分身调度                    │  │ │
│  │  │   - 结果验证        - 进度汇报        - 冲突仲裁                    │  │ │
│  │  └───────────────────────────────────────────────────────────────────┘  │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                      │                                        │
│  ┌ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐ │
│           末那识 (Manas) - 横切能力   ▼   破执纠偏 / 假设标注 / 范围守护       │
│  └ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┘ │
│                                      │                                        │
│                                      ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                      Six Roots Avatar System (六根分身)                   │ │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ │ │
│  │  │  👁️ 眼   │ │  👂 耳   │ │  👃 鼻   │ │  👅 舌   │ │  ⚔️ 身   │ │  🧠 意   │ │ │
│  │  │ 探索搜索 │ │ 需求理解 │ │ 审查检测 │ │ 测试文档 │ │ 代码实现 │ │ 架构设计 │ │ │
│  │  │  (BG)   │ │         │ │  (BG)   │ │         │ │         │ │         │ │ │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘ │ │
│  │                                                                           │ │
│  │  ┌───────────────────────────────────────────────────────────────────┐  │ │
│  │  │              🔮 内观悟空 (Introspector) - 超越六根                   │  │ │
│  │  │          偏差诊断 / 规则补丁 / 沉淀提炼 / 驱动规则迭代                │  │ │
│  │  └───────────────────────────────────────────────────────────────────┘  │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                      │                                        │
│                                      ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                  戒定慧三关护航 (Three Gates Verification)                │ │
│  │                                                                           │ │
│  │           六根输出 ──→ 戒关 ──→ 定关 ──→ 慧关 ──→ 阿赖耶识              │ │
│  │                      (规则)   (复现)   (抽象)    (沉淀)                  │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                      │                                        │
│                                      ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                  Ruyi Jingu Bang (如意金箍棒 - 上下文管理)                 │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐ │ │
│  │  │ 🔸 缩形态    │  │ 🔹 常形态    │  │ 🔶 巨形态    │  │   锚点系统       │ │ │
│  │  │   <500字    │  │  500-2000字  │  │   无限制     │  │ [D][C][I][P][U] │ │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                      │                                        │
│                                      ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                     Alaya Store (阿赖耶识 - 持久化存储)                    │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐ │ │
│  │  │  anchors.md │  │  notepads/  │  │  context/   │  │    skills/      │ │ │
│  │  │  ADR/锚点   │  │  Patterns   │  │Anti-patterns│  │  Checklists     │ │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Core Components (核心组件)

### 2.1 Six Roots Avatar System (六根分身系统)

> 源自佛教"六根"：眼、耳、鼻、舌、身、意六种感知器官。
>
> **核心原则**: 分身的"聪明"不是靠临场发挥，而是靠共享技能库把最佳实践固化。Skills = 共同语言/模板/套路，分身 = 执行器。

| 六根 | 分身 | 能力维度 | 职责 | Background |
|------|------|----------|------|------------|
| 👁️ 眼 | 眼分身 | 观察·探索·搜索 | 代码探索、信息搜索、依赖分析 | Yes |
| 👂 耳 | 耳分身 | 倾听·理解·需求 | 需求分析、边界条件、验收标准 | No |
| 👃 鼻 | 鼻分身 | 感知·审查·检测 | 代码审查、安全扫描、质量检测 | Yes |
| 👅 舌 | 舌分身 | 表达·沟通·文档 | 测试编写、文档生成、报告输出 | No |
| ⚔️ 身 | 斗战胜佛 | 执行·实现·行动 | 代码实现、Bug修复、技术攻关 | No |
| 🧠 意 | 意分身 | 思考·设计·决策 | 架构设计、技术选型、方案规划 | No |
| 🔮 超越 | 内观悟空 | 反思·锚点·健康 | 偏差诊断、规则补丁、沉淀提炼 | No |

### 2.1.1 Avatar Capability Triad (分身职能三件套)

> 每个分身强制三件事写死：职责边界、输出契约、工具权限。用机制约束，而不是靠 prompt。

#### 👁️ 眼分身 (Explorer)
| 维度 | 内容 |
|------|------|
| **Do** | 代码探索、依赖分析、信息搜索、现状调研 |
| **Don't** | 修改文件、执行破坏性命令、做架构决策 |
| **Output Contract** | `{files: [], patterns: [], dependencies: [], summary: ""}` |
| **Tool Allowlist** | Read, Glob, Grep, WebSearch, WebFetch |

#### 👂 耳分身 (Analyst)
| 维度 | 内容 |
|------|------|
| **Do** | 需求澄清、边界识别、AC 定义、用户意图理解 |
| **Don't** | 技术方案设计、代码实现、文件修改 |
| **Output Contract** | `{requirements: [], acceptance_criteria: [], edge_cases: [], clarifications: []}` |
| **Tool Allowlist** | Read (limited), Glob |

#### 👃 鼻分身 (Reviewer)
| 维度 | 内容 |
|------|------|
| **Do** | 代码审查、安全扫描、质量检测、问题识别 |
| **Don't** | 修改代码、实现修复、做架构变更 |
| **Output Contract** | `{issues: [{severity, file, line, description, suggestion}], passed: bool}` |
| **Tool Allowlist** | Read, Glob, Grep, mcp__ide__getDiagnostics |

#### 👅 舌分身 (Tester)
| 维度 | 内容 |
|------|------|
| **Do** | 测试编写、文档生成、测试执行、报告输出 |
| **Don't** | 修改生产代码、做架构决策 |
| **Output Contract** | `{tests_written: [], tests_passed: bool, coverage: "", docs: []}` |
| **Tool Allowlist** | Read, Write (tests/docs only), Bash (pytest/npm test) |

#### ⚔️ 斗战胜佛 (Implementer)
| 维度 | 内容 |
|------|------|
| **Do** | 代码实现、Bug 修复、技术攻关、重构执行 |
| **Don't** | 需求变更、超出领地、跳过测试 |
| **Output Contract** | `{files_changed: [], implementation_summary: "", ready_for_review: bool}` |
| **Tool Allowlist** | All (full access within declared territory) |

#### 🧠 意分身 (Architect)
| 维度 | 内容 |
|------|------|
| **Do** | 架构设计、技术选型、方案规划、ADR 编写 |
| **Don't** | 直接实现代码、越过设计阶段 |
| **Output Contract** | `{design: "", alternatives: [], decision: "", rationale: "", impact: []}` |
| **Tool Allowlist** | Read, Glob, WebSearch, Write (design.md only) |

#### 🔮 内观悟空 (Introspector)
| 维度 | 内容 |
|------|------|
| **Do** | 偏差诊断、规则补丁建议、沉淀提炼、锚点维护 |
| **Don't** | 直接实现、执行任务、修改生产代码 |
| **Output Contract** | `{what_worked: [], what_failed: [], root_cause: "", rule_patch: "", candidate_anchors: []}` |
| **Tool Allowlist** | Read, Write (context/ only) |

### 2.2 Body's Role (本体职责)

**本体（悟空）专注于:**
- 与用户对话交互
- 理解用户意图
- 分析任务并行机会
- 调度和协调分身
- 验证分身的工作
- 汇报进度和结果

**本体边界约束:**
```
❌ 本体不直接做:
├── 大量代码实现 (>50行 → 交给斗战胜佛)
├── 复杂的代码探索 (→ 交给眼分身)
├── 详细的测试编写 (→ 交给舌分身)
└── 架构设计方案 (→ 交给意分身)
```

### 2.3 Explicit Avatar Syntax (显式分身指定)

> 使用 `@` 语法可以绕过轨道选择，直接指定分身执行任务。

| @ 标记 | 分身 | 英文别名 |
|--------|------|----------|
| `@眼` | 眼分身 | `@explorer` |
| `@耳` | 耳分身 | `@analyst` |
| `@鼻` | 鼻分身 | `@reviewer` |
| `@舌` | 舌分身 | `@tester` |
| `@身` / `@斗战胜佛` | 斗战胜佛 | `@impl` |
| `@意` | 意分身 | `@architect` |
| `@内观` | 内观悟空 | `@reflect` |

**语法**: `/wukong @{分身} {任务描述}`

---

## 3. Eight Consciousness Verification (八识验证体系)

> 融合佛教八识哲学，构建完整的验证体系。

### 3.1 Manas as Cross-Cutting Concern (末那识 - 横切能力)

> **末那识不是验证流水线的一部分，而是横切能力**：贯穿所有分身输出，前置拦截 LLM 常见幻觉。

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        末那识 (Manas) - 破执纠偏                              │
│  ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─  │
│                                                                               │
│   ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐   │
│   │  眼分身  │    │  耳分身  │    │  斗战胜佛 │    │  舌分身  │    │  鼻分身  │   │
│   └────┬────┘    └────┬────┘    └────┬────┘    └────┬────┘    └────┬────┘   │
│        │              │              │              │              │         │
│   ─ ─ ─│─ ─ ─ ─ ─ ─ ─│─ ─ ─ ─ ─ ─ ─│─ ─ ─ ─ ─ ─ ─│─ ─ ─ ─ ─ ─ ─│─ ─ ─ ─  │
│        ▼              ▼              ▼              ▼              ▼         │
│   末那识审查     末那识审查     末那识审查     末那识审查     末那识审查        │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘
```

**末那识检查项:**

| 检查维度 | 内容 | 触发条件 |
|----------|------|----------|
| **假设标注** | 标注未验证假设 (Assumption Register) | "应该可以..."、"我觉得..." |
| **过度自信** | 识别无证据的自信结论 | 未引用具体文件/行号的断言 |
| **范围蔓延** | 检查是否偏离 AC 或超出范围 | 实现内容超出任务描述 |
| **复杂化倾向** | 检测"为了炫技而复杂化" | 引入非必要的抽象层/依赖 |

**末那识输出结构:**
```yaml
manas_review:
  assumptions:           # 未验证的假设列表
    - "假设 API 返回格式固定"
  evidence_missing:      # 缺失的证据
    - "未验证文件是否存在"
  scope_creep_risk:      # 范围蔓延风险
    level: low|medium|high
    reason: ""
  suggested_checks:      # 建议的验证步骤
    - "先运行 ls 确认文件存在"
```

### 3.2 Three Gates Pipeline (戒定慧三关流水线)

```
六根分身输出 (经末那识审查后)
         │
         ▼
┌─────────────────┐
│     戒 关       │  ← 是否违反规则？
│  (Sila Gate)    │     Output Contract / Do-Don't 边界
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│     定 关       │  ← 是否可复现/可运行？
│  (Samadhi Gate) │     L2 本地验证
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│     慧 关       │  ← 是否验证 & 可抽象？
│  (Prajna Gate)  │     L3 集成验证 + ADR 提取
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   阿赖耶识      │  ← 沉淀为长期能力
│  (Alaya Store)  │
└─────────────────┘
```

### 3.3 Evidence Levels (证据等级)

| Level | 名称 | 说明 | 状态 |
|-------|------|------|------|
| **L0** | 推测 (Speculation) | 基于经验的猜测 | ❌ 不过关 |
| **L1** | 引用 (Reference) | 引用但未验证 | ⚠️ 条件过关 |
| **L2** | 本地验证 (Local) | 本地命令验证 | ✅ 默认过关 |
| **L3** | 集成验证 (Integration) | 端到端验证 | ✅✅ 完全过关 |

### 3.4 Three Gates (戒定慧三关)

| 关卡 | 梵文 | 检查内容 | 失败处理 |
|------|------|----------|----------|
| **戒关** | Sila | Output Contract 完整性、边界遵守 | 打回重做 |
| **定关** | Samadhi | 可复现、可运行、测试通过 | 补充验证 |
| **慧关** | Prajna | 验证充分性、可抽象性、ADR 提取 | 补充+沉淀 |

### 3.5 Karma Classification (业力分类)

```
┌─────────────────────────────────────────────────────────┐
│  正业 (Kusala Karma) - 善业                              │
│  ├── 可复用的好决策 → 沉淀为锚点                         │
│  ├── 经过验证的模式 → 跨会话复用                         │
│  └── 稳定的接口定义                                      │
├─────────────────────────────────────────────────────────┤
│  中业 (Avyakata Karma) - 无记业                          │
│  ├── 一次性决策 → 记录但不沉淀                           │
│  └── 临时性方案 → 会话结束后可丢弃                       │
├─────────────────────────────────────────────────────────┤
│  恶业 (Akusala Karma) - 不善业                          │
│  ├── 技术债 → 标记为 [P] 问题锚点                        │
│  └── 临时 workaround → 待后续处理                        │
└─────────────────────────────────────────────────────────┘
```

---

## 4. Context Management (如意金箍棒)

> 大可顶天立地，小可藏于耳内。信息亦如金箍棒，可伸可缩，随需而变。

### 4.1 Three Forms (三态摘要)

| 形态 | 符号 | 字数限制 | 适用场景 |
|------|------|----------|----------|
| **缩形态** | 🔸 | <500 | 分身启动、跨会话传递、上下文紧张 |
| **常形态** | 🔹 | 500-2000 | 正常工作、信息传递 |
| **巨形态** | 🔶 | 无限制 | 完整上下文、调试、存档 |

**自动切换规则:**
```
上下文使用:
├── < 50%  → 🔶 巨形态
├── 50-75% → 🔹 常形态
├── 75-90% → 🔸 缩形态 + DCP 修剪
└── > 90%  → 存档 + 压缩
```

### 4.2 Anchor System (锚点系统)

> 锚点 = ADR (Architecture Decision Record)，关键信息通过锚点永不丢失。

| 类型 | 前缀 | 业力 | 说明 | 示例 |
|------|------|------|------|------|
| 决策 | D | 正业 | 架构/技术决策 | [D001] 使用 Ollama 而非 OpenAI |
| 约束 | C | 戒律 | 必须遵守的规则 | [C001] 所有输出必须脱敏 |
| 接口 | I | 正业 | 关键接口定义 | [I001] Agent.review() -> ReviewResult |
| 问题 | P | 恶业 | 已知问题/陷阱 | [P001] FFmpeg 某格式下泄漏内存 |
| 偏好 | U | 习气 | 用户偏好 | [U001] 用户偏好简洁回复 |
| 模式 | M | 正业 | 可复用模式 | [M001] 使用 Repository 模式 |

**锚点 ADR 格式:**
```markdown
## [D001] 使用 Ollama 作为本地 LLM

**ID**: D001
**日期**: 2024-01-15
**状态**: ✅ 生效

### Decision (决策)
使用 Ollama 作为代码审查的本地 LLM 后端。

### Alternatives (备选方案)
| 方案 | 优点 | 缺点 |
|------|------|------|
| OpenAI API | 能力强 | 成本高、数据出境 |
| Ollama 本地 | 免费、数据本地 | 需要部署维护 |

### Why (理由)
1. 成本: 本地运行零 API 费用
2. 隐私: 代码数据不出本地

### Impact (影响范围)
- `src/llm/`: LLM 接口模块
- `docker-compose.yaml`: 需要添加 Ollama 容器

### Rollback (回滚方式)
设置环境变量 `LLM_BACKEND=openai`
```

### 4.3 Alaya Write Rules (阿赖耶识写入规则)

> **只存"可复用的事实与结果"**，而不是什么都存。写入需满足任一门槛条件。

#### 写入门槛 (任一即可)

| 门槛 | 说明 | 示例 |
|------|------|------|
| **重复出现** | 出现 >=2 次 | 同样的问题第二次遇到 |
| **影响面大** | 核心模块/安全/性能 | 认证模块的设计决策 |
| **明确可复用** | 能直接当模板或约束 | 可复用的检查清单 |

#### 沉淀分类

| 分类 | 内容 | 存储位置 |
|------|------|----------|
| **ADR/锚点** | 关键决策与理由 | `anchors.md` |
| **Patterns** | 成功模式（何时用、怎么用） | `notepads/{plan}/patterns.md` |
| **Anti-patterns** | 失败模式（症状→原因→避免） | `notepads/{plan}/anti-patterns.md` |
| **Checklists** | 可复用检查清单 | `skills/` or `notepads/` |
| **Domain Notes** | 项目域知识 | `notepads/{plan}/domain.md` |

#### 沉淀格式示例

```markdown
## Pattern: Repository 模式处理数据访问

**何时用**: 需要隔离数据访问逻辑时
**怎么用**:
1. 定义 Repository 接口
2. 实现具体 Repository 类
3. 通过 DI 注入

**示例**: `src/repositories/user_repository.py`

---

## Anti-pattern: 在循环中调用 API

**症状**: 请求缓慢、频繁超时
**原因**: N+1 问题，每次循环都发起网络请求
**避免**: 批量查询或缓存
```

### 4.4 DCP (Dynamic Context Pruning)

**修剪策略:**

| 策略 | 说明 |
|------|------|
| 🔄 Deduplication | 同一文件的多次读取，只保留最新结果 |
| 📝 Supersede | 写入后又被读取的文件，删除写入内容 |
| ❌ Purge Errors | N 轮后清理失败的工具调用输入 |
| ✂️ Truncation | 搜索类输出动态截断 |

**保护机制:**
- 🛡️ 轮次保护: 最近 4 轮不修剪
- 📌 锚点保护: 包含锚点引用的内容永不修剪

---

## 5. Orchestration System (编排系统)

### 5.1 Four Tracks (四条轨道)

| 轨道 | 触发词 | 工作流 | Gate 要求 |
|------|--------|--------|-----------|
| **Feature** | Add, Create, New | 耳→意→斗战胜佛→舌→鼻 | L2 + AC 覆盖 |
| **Fix** | Fix, Bug, Error | 眼+鼻→斗战胜佛→舌 | L2 + 复现用例 |
| **Refactor** | Refactor, Clean | 眼→意→斗战胜佛→舌+鼻 | L2 + 行为不变 |
| **Direct** | 简单任务, @ 召唤 | 直接执行 | L1 (可降级) |

### 5.2 Feature Track DAG (功能开发默认依赖图)

```
┌─────────────────────────────────────────────────────────────────┐
│  Phase 1: 需求+探索 (并行)                                        │
│  ┌─────────┐    ┌─────────┐                                      │
│  │ 👂 耳    │    │ 👁 眼    │  ← 可并行，无依赖                    │
│  │ 需求澄清  │    │ 现状探索  │                                      │
│  └────┬────┘    └────┬────┘                                      │
│       └──────┬───────┘                                            │
│              ▼                                                    │
├─────────────────────────────────────────────────────────────────┤
│  Phase 2: 设计 (串行)                                             │
│              ┌─────────┐                                          │
│              │ 🧠 意    │  ← 依赖 Phase 1 输出                     │
│              │ 架构设计  │                                          │
│              └────┬────┘                                          │
│                   ▼                                               │
├─────────────────────────────────────────────────────────────────┤
│  Phase 3: 实现 (串行)                                             │
│              ┌─────────┐                                          │
│              │ ⚔️ 身    │  ← 依赖设计方案                          │
│              │ 代码实现  │                                          │
│              └────┬────┘                                          │
│                   ▼                                               │
├─────────────────────────────────────────────────────────────────┤
│  Phase 4: 验证+审查 (并行)                                        │
│  ┌─────────┐    ┌─────────┐                                      │
│  │ 👅 舌    │    │ 👃 鼻    │  ← 可并行，无依赖                    │
│  │ 测试编写  │    │ 代码审查  │                                      │
│  └────┬────┘    └────┬────┘                                      │
│       └──────┬───────┘                                            │
│              ▼                                                    │
├─────────────────────────────────────────────────────────────────┤
│  Phase 5: 收敛 (本体)                                             │
│              ┌─────────┐                                          │
│              │ 🐵 本体  │  ← 汇总、验证、交付报告                   │
│              │ Gate验证 │                                          │
│              └─────────┘                                          │
└─────────────────────────────────────────────────────────────────┘
```

### 5.3 Parallel Patterns (并行模式)

| 模式 | 场景 | 实现方式 | 加速比 |
|------|------|----------|--------|
| **分身群攻** | 多独立模块实现 | 多个 Subagent 并行 | ~Nx |
| **侦察兵+主力军** | 实现+参考探索 | 1 BG 眼 + 1 FG 斗战胜佛 | ~1.5x |
| **TDD钳形攻势** | 接口已定义 | 2 Subagent: 舌+斗战胜佛 | ~2x |
| **代码+配置并行** | 代码+部署配置 | 1 Subagent + BG Bash | ~1.5x |
| **蜂群模式** | 批量文件修改 | 多 BG Subagent | ~Nx |

### 5.4 Territory Protocol (领地协议)

> 并行实现时最容易撞车：两个分身改同一个文件。

```
领地声明规则:
├── 1️⃣ 实现前声明领地 (文件/函数/类级别)
├── 2️⃣ 领地互斥 (其他分身不得写入)
└── 3️⃣ 冲突处理 (本体重新分区或串行化)
```

### 5.5 Conflict Arbitration (冲突仲裁)

**裁决三准则 (按优先级):**

| 优先级 | 准则 | 说明 |
|--------|------|------|
| 1️⃣ | 满足 AC 优先 | 哪个方案能满足验收标准 |
| 2️⃣ | 风险可控优先 | 安全/数据丢失风险必须优先考虑 |
| 3️⃣ | 最小改动优先 | 能小改不大改，避免过度工程 |

---

## 6. Knowledge Inheritance (知识传承)

### 6.1 Notepad Structure (笔记本结构)

```
.wukong/notepads/{plan-name}/
├── requirements.md    # 需求规格书 (耳分身产出)
├── design.md          # 架构设计 (意分身产出)
├── decisions.md       # 决策记录 (ADR)
├── patterns.md        # 成功模式 (何时用、怎么用)
├── anti-patterns.md   # 失败模式 (症状→原因→避免)
├── domain.md          # 项目域知识
├── issues.md          # 问题跟踪
├── review.md          # 审查结果 (鼻分身产出)
├── verification.md    # 验证记录
└── breakthroughs.md   # 技术突破记录 (Eureka!)
```

### 6.2 Introspection Mechanism (内观机制)

> **内观不做"总结"，做"机制改进"**。每次只聚焦三件事，驱动规则迭代。

**触发条件:**

| 触发条件 | 内观深度 | 说明 |
|----------|----------|------|
| 复杂任务完成 | 深度 | 多分身协作的任务 |
| 任务失败/重做 | 深度 | 分析失败原因 |
| 用户主动请求 | 按需 | "反思一下"、"内观" |
| 上下文 > 75% | 标准 | 存档前反思 |
| 会话即将结束 | 快速 | 确保跨会话传递就绪 |

**内观聚焦三件事 (核心职责):**

```
┌──────────────────────────────────────────────────────────┐
│  1️⃣ 偏差诊断                                              │
│     本次协作哪里最浪费？为什么？                           │
│     (不是泛泛总结，而是定位具体的效率损失点)               │
├──────────────────────────────────────────────────────────┤
│  2️⃣ 规则补丁                                              │
│     需要新增/收紧/放宽哪条规则？                           │
│     (输出 diff-like 的规则修改建议)                       │
├──────────────────────────────────────────────────────────┤
│  3️⃣ 沉淀提炼                                              │
│     哪些信息值得写入阿赖耶识？                            │
│     (满足写入门槛才沉淀，不是什么都存)                    │
└──────────────────────────────────────────────────────────┘
```

**内观输出格式:**

```yaml
introspection:
  what_worked:           # 有效的做法
    - "并行探索+设计显著提速"
  what_failed:           # 失败/浪费的地方
    - "眼分身搜索范围过大，返回太多无关文件"
  root_cause:            # 流程层面的根因
    "眼分身缺乏明确的搜索范围约束"
  rule_patch:            # 规则修改建议 (diff-like)
    - action: add
      rule: "眼分身搜索前必须声明搜索范围"
    - action: tighten
      rule: "Glob 结果超过 20 个文件时必须二次过滤"
  candidate_anchors:     # 待沉淀的锚点 ID
    - "[D003] 使用 AST 而非正则解析代码"
    - "[M002] 分层搜索模式"
```

---

## 7. Claude Code Alignment (与 Claude Code 对齐)

### 7.1 Avatar to Subagent/Skill Mapping

| 分身 | 推荐实现 | 理由 |
|------|----------|------|
| 👁️ 眼分身 | **Subagent** | 重工具使用，上下文隔离，可后台运行 |
| 👂 耳分身 | **Skill** | 认知工作，需要完整用户上下文 |
| 👃 鼻分身 | **Subagent** | 独立审查上下文，可后台运行 |
| 👅 舌分身 | **Hybrid** | Skill (策略) + Subagent (执行) |
| ⚔️ 斗战胜佛 | **Subagent** | 重文件操作，需要上下文隔离 |
| 🧠 意分身 | **Skill** | 设计思考，需要完整上下文 |
| 🔮 内观悟空 | **Skill** | 需要访问整个对话进行反思 |

### 7.2 Hooks Integration (Hooks 落地点)

| 验证阶段 | Claude Code Hook | 实现 |
|----------|------------------|------|
| 末那识 | PreToolUse | 检测假设性语言，要求证据 |
| 戒关 | PreToolUse | 阻止分身越界使用工具 |
| 定关 | PermissionRequest | 自动放行验证命令 |
| 慧关 | SubagentStop | 触发结果验证 |
| 阿赖耶识 | SubagentStop + PreCompact | 提取锚点，生成缩形态 |

### 7.3 Tool Permission Matrix (工具权限)

| 分身 | 允许工具 | 禁止工具 |
|------|----------|----------|
| 👁️ 眼 | Read, Glob, Grep, WebSearch | Write, Edit |
| 👂 耳 | Read (limited), Glob | Write, Edit, Bash |
| 👃 鼻 | Read, Glob, Grep, Diagnostics | Write, Edit |
| 👅 舌 | Read, Write (tests), Bash (pytest) | Edit (prod code) |
| ⚔️ 身 | All (full access) | None |
| 🧠 意 | Read, Glob, WebSearch | Write (except design.md) |
| 🔮 内观 | Read, Write (context/) | Edit, Bash |

---

## 8. File Structure (文件结构总览)

```
.wukong/
├── rules/                      # 核心规则
│   ├── 00-wukong-core.md       # 核心协议
│   ├── 01-task-orchestration.md # 编排协议
│   ├── 02-verification.md      # 验证协议
│   ├── 03-avatars.md           # 六根分身系统
│   ├── # (已合并到 shi.md)
│   └── 05-ruyi-protocol.md     # 金箍棒协议
│
├── skills/                     # 分身技能 (Multiagent 共享)
│   ├── explorer.md             # 眼分身技能
│   ├── requirements-analyst.md # 耳分身技能
│   ├── code-reviewer.md        # 鼻分身技能
│   ├── tester.md               # 舌分身技能
│   ├── implementer.md          # 斗战胜佛技能
│   ├── architect.md            # 意分身技能
│   ├── # (已合并到 hui.md)
│   ├── orchestration.md        # 编排详细模式
│   ├── verification.md         # 验证详细命令
│   ├── # (已合并到 shi.md)
│   └── ruyi.md                 # 金箍棒完整协议
│
├── commands/                   # 命令定义
│   └── wukong.md               # /wukong 命令
│
├── context/                    # 上下文管理
│   ├── anchors.md              # 全局锚点索引
│   ├── current/                # 当前会话
│   │   ├── compact.md          # 缩形态
│   │   ├── normal.md           # 常形态
│   │   └── expanded.md         # 巨形态
│   ├── sessions/               # 历史会话存档
│   └── templates/              # 模板
│
├── notepads/                   # 知识库
│   └── {plan-name}/            # 按计划组织
│       ├── requirements.md
│       ├── design.md
│       ├── learnings.md
│       ├── decisions.md
│       └── ...
│
├── templates/                  # 模板
│   ├── notepad/                # 笔记本模板
│   └── plan.md                 # 计划模板
│
└── plans/                      # 计划文档
    └── {plan-name}.md
```

---

## 9. Quick Reference (快速参考)

### 9.1 Summoning Syntax (召唤语法)

```python
# 标准召唤
"""
召唤分身:
- 六根: [眼/耳/鼻/舌/身/意]
- 原因: {why}
- 产出: {expected}
"""

skill = Read(f".wukong/skills/{skill_file}.md")
Task(prompt=f"{skill}\n\n## TASK\n{task}", run_in_background=bg)

# 显式召唤
/wukong @身 实现用户认证模块
```

### 9.2 Verification Checklist (验证清单)

```
□ 文件存在 (Glob/Read)
□ 构建通过 (cmake/python -m build)
□ 测试通过 (pytest/ctest)
□ 类型检查 (mypy)
□ 行为符合 AC
```

### 9.3 Context Commands (上下文命令)

| 命令 | 动作 |
|------|------|
| `内观` | 偏差诊断 + 规则补丁 + 沉淀提炼 |
| `压缩` | 生成 🔸 缩形态摘要 |
| `存档` | 保存到 sessions/ |
| `加载 {name}` | 恢复历史会话 |
| `锚点` | 显示关键决策/约束 |
| `修剪` | 执行 DCP 动态修剪 |

### 9.4 Anti-Patterns (反模式)

```
🚫 本体越权: 连续 Write/Edit 超过 3 次
🚫 忽视并行: 无依赖任务串行执行
🚫 跳过测试: 实现完成但没有舌分身验证
🚫 过度信任: 分身说完成就直接结束
🚫 阻塞等待: 召唤分身后不返回用户
🚫 跳过探索: Feature Track 没有先探索
🚫 跳过审查: 实现后没有鼻分身审查
```

---

## 10. Philosophy Summary (哲学总结)

```
悟空 = 硅谷工程师心态 + 西游记精神

六根 = 感知世界的六个维度，化为六种专业能力
八识 = 认知处理的完整流水线，化为验证机制
金箍棒 = 可伸缩的武器，化为可伸缩的上下文
取经路 = 需求即取经，代码即降妖伏魔

本体 = 调度协调者，不是执行者
分身 = 专业执行者，有严格边界 (职能三件套约束)
末那识 = 横切能力，前置拦截 LLM 幻觉
验证 = NO EVIDENCE = NOT DONE
并行 = 一个筋斗十万八千里
内观 = 不做总结，做机制改进
阿赖耶识 = 沉淀长期能力，不是什么都存
```

**系统宣言 (重申):**
> 六根并行生产，末那识破执纠偏；戒定慧三关护航；内观驱动规则迭代；阿赖耶识沉淀为长期能力。

---

*此文档由 Wukong 意分身 (架构悟空) 创建于 2025-01-12*
*版本 2.0 更新于 2026-01-12 - 新增系统宣言、职能三件套、末那识横切能力、内观聚焦机制、阿赖耶识写入规则*
