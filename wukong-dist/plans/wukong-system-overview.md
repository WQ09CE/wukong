# Wukong 系统架构总览

> **悟空** - 基于六根分身的 AI Agent 多智能体协作系统

## 一、系统宣言

```
六根并行生产；戒定慧识四大护航；PreCompact 自动沉淀。
```

## 二、核心架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户 (User)                               │
└───────────────────────────┬─────────────────────────────────────┘
                            │ /wukong 命令
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                      悟空本体 (Coordinator)                       │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ • 用户交互        • 轨道选择        • 结果验证              ││
│  │ • 任务分解        • 分身调度        • 进度汇报              ││
│  └─────────────────────────────────────────────────────────────┘│
└───────────────────────────┬─────────────────────────────────────┘
                            │ Task() 召唤
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                    六根分身 (Six Roots Avatars)                   │
│                                                                  │
│   👁️眼      👂耳      👃鼻      👅舌      ⚔️身       🧠意        │
│   探索      需求      审查      测试      实现       设计        │
│   搜索      理解      检测      文档      行动       决策        │
│                                                                  │
└───────────────────────────┬─────────────────────────────────────┘
                            │ 输出
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                   戒定慧识 (Four Pillars)                        │
│                                                                  │
│   ⛔戒 ────→ 🎯定 ────→ 💡慧 ────→ 📚识                         │
│   规则检查    可复现      反思沉淀    存储反馈                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 三、六根分身系统

### 3.1 分身职能表

| 六根 | 分身 | 能力 | 后台 | Do | Don't | 工具权限 |
|------|------|------|------|-----|-------|----------|
| 👁️眼 | 眼分身 | 探索·搜索 | ✓ | 搜索、定位、发现 | 修改代码 | Glob,Grep,Read |
| 👂耳 | 耳分身 | 需求·理解 | - | 澄清需求、定义AC | 实现设计 | Read |
| 👃鼻 | 鼻分身 | 审查·检测 | ✓ | 审查、扫描、检测 | 修复代码 | Read,Grep |
| 👅舌 | 舌分身 | 测试·文档 | - | 写测试、写文档 | 实现功能 | Read,Write,Bash |
| ⚔️身 | 斗战胜佛 | 实现·行动 | - | 写代码、修复 | 跳过测试 | All |
| 🧠意 | 意分身 | 设计·决策 | - | 架构设计、技术决策 | 写实现 | Read,Write(md) |

### 3.2 职能三件套

每个分身强制定义三件事：
1. **职责边界** (Do/Don't) - 明确能做什么、不能做什么
2. **输出契约** (Output Contract) - 标准化输出格式
3. **工具权限** (Tool Allowlist) - 可使用的工具列表

### 3.3 召唤语法

**显式指定 (@语法):**
```
/wukong @眼 探索认证模块
/wukong @斗战胜佛 实现用户登录
/wukong @意 设计缓存方案
```

**自动轨道选择:**
```
/wukong 添加用户认证功能  → Feature Track: 耳→意→身→舌→鼻
/wukong 修复登录 bug      → Fix Track: 眼→身→舌
/wukong 重构数据库层      → Refactor Track: 眼→意→身→舌
```

## 四、戒定慧识四大模块

### 4.1 流程概览

```
分身输出 ──→ ⛔戒 ──→ 🎯定 ──→ 💡慧 ──→ 📚识
            规则检查   可复现    反思沉淀   存储反馈

违规→打回   无证据→拒绝  提取锚点   写入anchors
```

### 4.2 ⛔ 戒 (Jie) - 规则检查

**检查项:**
- Contract 完整性 (必须 section 齐全)
- Do/Don't 边界 (无越界行为)
- 安全检查 (无敏感信息/危险命令)

**违规处理:** 打回重做

### 4.3 🎯 定 (Ding) - 可复现验证

**证据等级:**
| 等级 | 说明 | 可信度 |
|------|------|--------|
| L0 | 推测 ("应该可以...") | ❌ 不可信 |
| L1 | 引用 (文档/注释) | ⚠️ 条件可信 |
| L2 | 本地验证 (运行通过) | ✅ 默认可信 |
| L3 | 集成验证 (CI 通过) | ✅✅ 完全可信 |

**金规:** 没有证据 = 没有完成

### 4.4 💡 慧 (Hui) - 反思与沉淀

**职责:**
- 末那识扫描 (检测假设/偏执)
- 内观反思 (偏差诊断)
- 锚点提取 (识别值得沉淀的信息)
- 触发识写入

**触发时机:**
- `/wukong 内观` (手动)
- PreCompact Hook (自动压缩前)
- 复杂任务完成后

**危险信号 (必须拦截):**
- "应该可以..." / "大概能..." → L0 推测
- "没有问题" / "应该没事" → 乐观偏见

### 4.5 📚 识 (Shi) - 信息存储与反馈

**存储类型:**
```
.wukong/context/
├── anchors.md          # 永久锚点索引
├── index.json          # 会话索引
├── current/            # 当前会话
│   └── compact.md      # 缩形态上下文
└── sessions/           # 历史存档
    └── {timestamp}-{id}/
```

**写入门槛 (至少满足一项):**
- 重复 ≥ 2: 类似问题/决策出现两次以上
- 影响大: 涉及架构、安全、性能、多模块
- 可复用: 在其他项目/场景中有参考价值

**惯性提示 (识→六根反馈):**

| 时机 | 查询类型 | 输出内容 | 适用分身 |
|------|----------|----------|----------|
| T1 (任务启动前) | P/C/M | 风险预警、约束提醒 | 眼、身、舌、鼻 |
| T2 (方案冻结后) | D/I | 历史决策、回滚经验 | 意、身、鼻 |

## 五、锚点系统

### 5.1 锚点类型

| 类型 | 前缀 | 说明 | 示例 |
|------|------|------|------|
| 决策 | D | 架构/技术决策 | [D001] 采用六根分身模型 |
| 约束 | C | 必须遵守的规则 | [C001] 输出必须脱敏 |
| 接口 | I | 关键接口定义 | [I001] Sanitizer.sanitize() |
| 问题 | P | 已知问题/陷阱 | [P001] 串行执行反模式 |
| 模式 | M | 可复用模式 | [M001] Repository 模式 |
| 偏好 | U | 用户偏好 | [U001] 偏好简洁回复 |

### 5.2 锚点引用

在任何地方通过 `[D001]` 格式引用：
```markdown
根据 [D001]，我们采用六根分身模型。
考虑到 [C001] 的脱敏要求，返回前需调用 Sanitizer。
```

## 六、筋斗云 (并行执行)

### 6.1 并行原则

- **最大并行:** 3-4 个分身
- **同一文件:** 必须串行
- **有依赖链:** 按顺序执行

### 6.2 强制并行条件

以下情况**必须**拆分并行：
- 修改 ≥2 个独立文件 → 每文件一个分身
- 涉及 ≥2 个独立模块 → 每模块一个分身
- 用户要求"同时/并行/一起" → 必须并行

### 6.3 召唤前自检

> "这个任务涉及几个独立文件/模块？能拆成并行吗？"

## 七、上下文管理 (如意金箍棒)

### 7.1 三态形态

| 形态 | 标记 | 大小 | 用途 |
|------|------|------|------|
| 🔶 巨 | expanded | 无限制 | 调试复杂问题 |
| 🔹 常 | normal | 500-2000字 | 正常工作 |
| 🔸 缩 | compact | <500字 | 跨会话传递、分身启动 |

### 7.2 上下文命令

| 命令 | 动作 |
|------|------|
| `/wukong 内观` | 慧模块反思 + 提取锚点 |
| `/wukong 压缩` | 生成缩形态摘要 |
| `/wukong 存档` | 保存到 sessions/ |
| `/wukong 加载 {name}` | 恢复历史会话 |
| `/wukong 锚点` | 显示所有锚点 |

### 7.3 PreCompact Hook

自动在上下文压缩前触发，执行慧模块提取：

```json
{
  "hooks": {
    "PreCompact": [{
      "matcher": "auto",
      "hooks": [{
        "type": "command",
        "command": "python3 ~/.wukong/hooks/hui-extract.py"
      }]
    }]
  }
}
```

## 八、本体边界

### 8.1 本体 MUST 委派

- 探索类任务 (多文件/目录) → @眼分身 (后台)
- 任何代码修改 (>10行) → @斗战胜佛
- 任何文件创建/写入 → @斗战胜佛
- 构建/测试执行 → @舌分身 或 @斗战胜佛
- 预估超过 30 秒的操作 → 分身 (后台优先)

### 8.2 本体 MAY 直接做

- 读取 1-2 个文件
- 单次 Glob/Grep
- 验证性检查
- 与用户对话
- 简单的单行修改 (<10行)

## 九、目录结构

```
项目根目录/
├── .claude/                    # Claude Code 配置
│   ├── rules/                  # 规则 (自动加载)
│   │   └── 00-wukong-core.md  # 核心规则
│   ├── skills/                 # 分身技能
│   │   ├── explorer.md        # 眼分身
│   │   ├── requirements-analyst.md  # 耳分身
│   │   ├── code-reviewer.md   # 鼻分身
│   │   ├── tester.md          # 舌分身
│   │   ├── implementer.md     # 斗战胜佛
│   │   ├── architect.md       # 意分身
│   │   ├── jie.md             # 戒模块
│   │   ├── ding.md            # 定模块
│   │   ├── hui.md             # 慧模块
│   │   ├── shi.md             # 识模块
│   │   └── jindouyun.md       # 筋斗云
│   └── commands/              # 命令
│       └── wukong.md          # /wukong 命令
│
└── .wukong/                   # Wukong 数据
    ├── context/               # 上下文存储
    │   ├── anchors.md        # 锚点索引
    │   ├── index.json        # 会话索引
    │   ├── current/          # 当前会话
    │   └── sessions/         # 历史存档
    ├── notepads/             # 记事本
    ├── plans/                # 计划文档
    └── templates/            # 模板

~/.wukong/                    # 全局配置
├── hooks/                    # Hook 脚本
│   └── hui-extract.py       # 慧模块提取脚本
└── ...
```

## 十、紧箍咒 (约束)

### NEVER
- 跳过验证
- 未读代码就修改
- 本体写大量代码 (>10行)
- 串行执行可并行任务
- 违反分身职责边界
- 输出不符合 Contract
- 使用未授权的工具

### ALWAYS
- 验证分身输出
- 遵循现有代码风格
- 保持构建/测试通过
- 记录重要决策
- 分身输出后执行戒定慧检查
- 遵守职能三件套约束

## 十一、快速入门

### 11.1 安装

```bash
# 方式1: CLI 安装
pip install wukong-cli
wukong install /path/to/project

# 方式2: 脚本安装
./install.sh /path/to/project
```

### 11.2 使用

```bash
# 启动 Claude Code
claude

# 激活 Wukong
/wukong 你好

# 显式召唤分身
/wukong @眼 探索项目结构
/wukong @意 设计认证模块
/wukong @斗战胜佛 实现登录功能

# 自动轨道选择
/wukong 添加用户注册功能
/wukong 修复密码验证 bug

# 上下文管理
/wukong 内观
/wukong 锚点
```

## 十二、版本信息

- **版本**: 1.0
- **更新日期**: 2026-01-12
- **作者**: Wukong Team

---

> *"吾乃齐天大圣孙悟空，筋斗云十万八千里，七十二变随心所欲。"*
